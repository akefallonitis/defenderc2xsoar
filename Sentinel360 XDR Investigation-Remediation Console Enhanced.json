{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Sentinel360 XDR Investigation-Remediation Console Enhanced",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourcegroups/sentinel360-xdr/providers/microsoft.operationalinsights/workspaces/sentinel360-mssp",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"![Sentinel360](https://sentinel360.io/wp-content/uploads/2023/03/Sentinel360-Logo-245x98-1.png)\\n# üõ°Ô∏è Sentinel360 XDR SOAR Solution\\n## Multi-Tenant Investigation & Remediation Console with API Integration\\n\\n---\\n\\n### ‚ö° Real-time Monitoring | üîç Investigation | üö® Incident Management | ‚öôÔ∏è Automated Response\\n**Version:** 11.0 | **Platform:** Azure Lighthouse | **Status:** Production\"},\"name\":\"Header\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::all\"],\"parameters\":[{\"id\":\"subscription-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1},{\"id\":\"workspace-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| order by name asc\\r\\n| take 50\",\"crossComponentResources\":[\"{Subscriptions}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::10\"],\"showDefault\":false},\"defaultValue\":\"value::10\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"timerange-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true}},{\"id\":\"bearer-token-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"BearerToken\",\"label\":\"Bearer Token (for API operations)\",\"type\":1,\"description\":\"Enter your Bearer Token for Graph API/MDE operations\",\"value\":\"\",\"typeSettings\":{\"multiLineText\":false,\"editorLanguage\":\"text\"}}],\"style\":\"pills\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"GlobalParameters\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"dashboard-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üìä Dashboard\",\"subTarget\":\"Dashboard\",\"style\":\"link\"},{\"id\":\"incident-workflow-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üö® Incident Workflow\",\"subTarget\":\"IncidentWorkflow\",\"style\":\"link\"},{\"id\":\"entity-insights-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üîç Entity Insights\",\"subTarget\":\"EntityInsights\",\"style\":\"link\"},{\"id\":\"incident-management-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üìù Incident Management\",\"subTarget\":\"IncidentManagement\",\"style\":\"link\"},{\"id\":\"xdr-audit-tab\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üìã XDR Audit\",\"subTarget\":\"XDRAudit\",\"style\":\"link\"}]},\"name\":\"NavigationTabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityIncident\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize TotalIncidents = count()\\r\\n| extend Metric = \\\"Total Incidents\\\", Value = TotalIncidents\\r\\n| union (\\r\\n    SecurityIncident\\r\\n    | where TimeGenerated {TimeRange}\\r\\n    | where Severity == \\\"High\\\"\\r\\n    | summarize Value = count()\\r\\n    | extend Metric = \\\"High Severity\\\"\\r\\n)\\r\\n| union (\\r\\n    SecurityIncident\\r\\n    | where TimeGenerated {TimeRange}\\r\\n    | where Severity == \\\"Medium\\\"\\r\\n    | summarize Value = count()\\r\\n    | extend Metric = \\\"Medium Severity\\\"\\r\\n)\\r\\n| union (\\r\\n    SecurityIncident\\r\\n    | where TimeGenerated {TimeRange}\\r\\n    | where Status in (\\\"Active\\\", \\\"New\\\")\\r\\n    | summarize Value = count()\\r\\n    | extend Metric = \\\"Active Incidents\\\"\\r\\n)\\r\\n| union (\\r\\n    SecurityAlert\\r\\n    | where TimeGenerated {TimeRange}\\r\\n    | summarize Value = count()\\r\\n    | extend Metric = \\\"Total Alerts\\\"\\r\\n)\\r\\n| project Metric, Value\",\"size\":3,\"title\":\"Security Metrics\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Metric\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":true}},\"name\":\"MetricsTiles\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Dashboard\"},\"name\":\"DashboardTab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Entity Insights\\r\\nChoose an Entity Type to investigate by.\"},\"name\":\"EntityInsightsHeader\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"ip-tab\",\"cellValue\":\"entityTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Investigate IP Address\",\"subTarget\":\"IP\",\"style\":\"link\"},{\"id\":\"account-tab\",\"cellValue\":\"entityTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Investigate Account\",\"subTarget\":\"Account\",\"style\":\"link\"},{\"id\":\"host-tab\",\"cellValue\":\"entityTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Investigate Host\",\"subTarget\":\"Host\",\"style\":\"link\"},{\"id\":\"url-tab\",\"cellValue\":\"entityTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Investigate URL\",\"subTarget\":\"URL\",\"style\":\"link\"},{\"id\":\"filehash-tab\",\"cellValue\":\"entityTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Investigate File Hash\",\"subTarget\":\"FileHash\",\"style\":\"link\"}]},\"name\":\"EntityTabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"account-upn\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"UPN\",\"label\":\"UPN\",\"type\":2,\"query\":\"IdentityInfo\\r\\n| distinct AccountUPN\\r\\n| where isnotempty(AccountUPN)\\r\\n| order by AccountUPN asc\\r\\n| take 100\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"]},{\"id\":\"account-sam\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"samAccountName\",\"label\":\"samAccountName\",\"type\":2,\"query\":\"IdentityInfo\\r\\n| where AccountUPN == \\\"{UPN}\\\"\\r\\n| distinct AccountName\\r\\n| take 1\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"AccountParams\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"location-anomalies\",\"cellValue\":\"accountSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Location Anomalies\",\"subTarget\":\"LocationAnomalies\",\"style\":\"link\"},{\"id\":\"computer-logons\",\"cellValue\":\"accountSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Computer Logons\",\"subTarget\":\"ComputerLogons\",\"style\":\"link\"},{\"id\":\"conditional-access\",\"cellValue\":\"accountSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Conditional Access Analysis\",\"subTarget\":\"ConditionalAccess\",\"style\":\"link\"},{\"id\":\"iocs\",\"cellValue\":\"accountSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"IOCs\",\"subTarget\":\"IOCs\",\"style\":\"link\"},{\"id\":\"related-alerts\",\"cellValue\":\"accountSubTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Related Alerts & Bookmarks\",\"subTarget\":\"RelatedAlerts\",\"style\":\"link\"}]},\"name\":\"AccountSubTabs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where UserPrincipalName == \\\"{UPN}\\\"\\r\\n| summarize Count = count() by Location, IPAddress\\r\\n| order by Count desc\",\"size\":0,\"title\":\"Sign-in Locations for {UPN}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Location\",\"sizeSettings\":\"Count\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Count\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Count\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"conditionalVisibility\":{\"parameterName\":\"accountSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"LocationAnomalies\"},\"name\":\"LocationMap\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let logons = union isfuzzy=true\\r\\n    (SigninLogs | where UserPrincipalName == \\\"{UPN}\\\"),\\r\\n    (AADNonInteractiveUserSignInLogs | where UserPrincipalName == \\\"{UPN}\\\"),\\r\\n    (DeviceLogonEvents | where AccountName == \\\"{samAccountName}\\\")\\r\\n| where TimeGenerated {TimeRange}\\r\\n| project TimeGenerated, DeviceName = coalesce(DeviceName, \\\"Azure AD\\\"), LogonType = coalesce(LogonType, \\\"Interactive\\\"), IPAddress\\r\\n| order by TimeGenerated desc\\r\\n| take 100;\\r\\nlogons\",\"size\":0,\"title\":\"Computer Logons\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"accountSubTab\",\"comparison\":\"isEqualTo\",\"value\":\"ComputerLogons\"},\"name\":\"ComputerLogons\"},{\"type\":1,\"content\":{\"json\":\"### üîß Account Remediation Actions\\r\\n\\r\\n```powershell\\r\\n# Account: {UPN}\\r\\n$upn = \\\"{UPN}\\\"\\r\\n$bearerToken = \\\"{BearerToken}\\\"\\r\\n$headers = @{\\r\\n    \\\"Authorization\\\" = \\\"Bearer $bearerToken\\\"\\r\\n    \\\"Content-Type\\\" = \\\"application/json\\\"\\r\\n}\\r\\n\\r\\n# === AZURE AD ACTIONS ===\\r\\n# Disable Account\\r\\n$uri = \\\"https://graph.microsoft.com/v1.0/users/$upn\\\"\\r\\n$body = @{accountEnabled = $false} | ConvertTo-Json\\r\\nInvoke-RestMethod -Uri $uri -Headers $headers -Method PATCH -Body $body\\r\\n\\r\\n# Revoke All Sessions\\r\\n$revokeUri = \\\"https://graph.microsoft.com/v1.0/users/$upn/revokeSignInSessions\\\"\\r\\nInvoke-RestMethod -Uri $revokeUri -Headers $headers -Method POST\\r\\n\\r\\n# Reset Password (Beta API)\\r\\n$pwdUri = \\\"https://graph.microsoft.com/beta/users/$upn/authentication/passwordMethods/28c10230-6103-485e-b985-444c60001490/resetPassword\\\"\\r\\nInvoke-RestMethod -Uri $pwdUri -Headers $headers -Method POST\\r\\n\\r\\n# === IDENTITY PROTECTION ===\\r\\n# Mark User as Compromised\\r\\n$riskUri = \\\"https://graph.microsoft.com/v1.0/identityProtection/riskyUsers/confirmCompromised\\\"\\r\\n$riskBody = @{userIds = @($upn)} | ConvertTo-Json\\r\\nInvoke-RestMethod -Uri $riskUri -Headers $headers -Method POST -Body $riskBody\\r\\n\\r\\n# === CONDITIONAL ACCESS ===\\r\\n# Create Emergency Block Policy\\r\\n$capUri = \\\"https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies\\\"\\r\\n$capBody = @{\\r\\n    displayName = \\\"BLOCK - $upn - Security Incident\\\"\\r\\n    state = \\\"enabled\\\"\\r\\n    conditions = @{\\r\\n        users = @{\\r\\n            includeUsers = @($upn)\\r\\n        }\\r\\n        applications = @{\\r\\n            includeApplications = @(\\\"All\\\")\\r\\n        }\\r\\n    }\\r\\n    grantControls = @{\\r\\n        operator = \\\"OR\\\"\\r\\n        builtInControls = @(\\\"block\\\")\\r\\n    }\\r\\n} | ConvertTo-Json -Depth 10\\r\\nInvoke-RestMethod -Uri $capUri -Headers $headers -Method POST -Body $capBody\\r\\n\\r\\n# === MFA RESET ===\\r\\n# Reset MFA Methods\\r\\n$mfaUri = \\\"https://graph.microsoft.com/beta/users/$upn/authentication/methods\\\"\\r\\n$methods = Invoke-RestMethod -Uri $mfaUri -Headers $headers -Method GET\\r\\nforeach($method in $methods.value) {\\r\\n    $deleteUri = \\\"https://graph.microsoft.com/beta/users/$upn/authentication/methods/$($method.id)\\\"\\r\\n    Invoke-RestMethod -Uri $deleteUri -Headers $headers -Method DELETE\\r\\n}\\r\\n\\r\\nWrite-Host \\\"‚úÖ Account remediation complete for: $upn\\\"\\r\\n```\",\"style\":\"info\"},\"name\":\"AccountRemediation\"}]},\"conditionalVisibility\":{\"parameterName\":\"entityTab\",\"comparison\":\"isEqualTo\",\"value\":\"Account\"},\"name\":\"AccountInvestigation\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"host-name\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"HostName\",\"label\":\"Host Name\",\"type\":1,\"description\":\"Enter hostname to investigate\",\"value\":\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"HostParams\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DeviceProcessEvents\\r\\n| where DeviceName =~ \\\"{HostName}\\\"\\r\\n| where TimeGenerated {TimeRange}\\r\\n| project TimeGenerated, ProcessName = FileName, CommandLine = ProcessCommandLine, AccountName, ParentProcessName = InitiatingProcessFileName\\r\\n| order by TimeGenerated desc\\r\\n| take 100\",\"size\":0,\"title\":\"Process Activity on {HostName}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"HostName\",\"comparison\":\"isNotEqualTo\"},\"name\":\"HostProcesses\"},{\"type\":1,\"content\":{\"json\":\"### üîß Host Remediation Actions\\r\\n\\r\\n```powershell\\r\\n# Host: {HostName}\\r\\n$hostname = \\\"{HostName}\\\"\\r\\n$bearerToken = \\\"{BearerToken}\\\"\\r\\n$headers = @{\\r\\n    \\\"Authorization\\\" = \\\"Bearer $bearerToken\\\"\\r\\n    \\\"Content-Type\\\" = \\\"application/json\\\"\\r\\n}\\r\\n\\r\\n# === MICROSOFT DEFENDER FOR ENDPOINT ===\\r\\n# Find Device\\r\\n$searchUri = \\\"https://api.securitycenter.microsoft.com/api/machines?`$filter=computerDnsName eq '$hostname'\\\"\\r\\n$machine = Invoke-RestMethod -Uri $searchUri -Headers $headers -Method GET\\r\\n\\r\\nif($machine.value) {\\r\\n    $machineId = $machine.value[0].id\\r\\n    \\r\\n    # Isolate Device\\r\\n    $isolateUri = \\\"https://api.securitycenter.microsoft.com/api/machines/$machineId/isolate\\\"\\r\\n    $isolateBody = @{\\r\\n        Comment = \\\"Security Incident - Automated Isolation\\\"\\r\\n        IsolationType = \\\"Full\\\"\\r\\n    } | ConvertTo-Json\\r\\n    Invoke-RestMethod -Uri $isolateUri -Headers $headers -Method POST -Body $isolateBody\\r\\n    \\r\\n    # Run Full AV Scan\\r\\n    $scanUri = \\\"https://api.securitycenter.microsoft.com/api/machines/$machineId/runAntiVirusScan\\\"\\r\\n    $scanBody = @{\\r\\n        Comment = \\\"Automated Full Scan\\\"\\r\\n        ScanType = \\\"Full\\\"\\r\\n    } | ConvertTo-Json\\r\\n    Invoke-RestMethod -Uri $scanUri -Headers $headers -Method POST -Body $scanBody\\r\\n    \\r\\n    # Collect Investigation Package\\r\\n    $collectUri = \\\"https://api.securitycenter.microsoft.com/api/machines/$machineId/collectInvestigationPackage\\\"\\r\\n    $collectBody = @{Comment = \\\"Automated Collection\\\"} | ConvertTo-Json\\r\\n    Invoke-RestMethod -Uri $collectUri -Headers $headers -Method POST -Body $collectBody\\r\\n    \\r\\n    # Restrict Code Execution\\r\\n    $restrictUri = \\\"https://api.securitycenter.microsoft.com/api/machines/$machineId/restrictCodeExecution\\\"\\r\\n    $restrictBody = @{Comment = \\\"Automated Restriction\\\"} | ConvertTo-Json\\r\\n    Invoke-RestMethod -Uri $restrictUri -Headers $headers -Method POST -Body $restrictBody\\r\\n}\\r\\n\\r\\n# === AZURE VM ACTIONS (if applicable) ===\\r\\n# Stop VM\\r\\n$vmUri = \\\"https://management.azure.com/subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.Compute/virtualMachines/$hostname/powerOff?api-version=2021-03-01\\\"\\r\\nInvoke-RestMethod -Uri $vmUri -Headers $headers -Method POST\\r\\n\\r\\n# Deallocate VM\\r\\n$deallocateUri = \\\"https://management.azure.com/subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.Compute/virtualMachines/$hostname/deallocate?api-version=2021-03-01\\\"\\r\\nInvoke-RestMethod -Uri $deallocateUri -Headers $headers -Method POST\\r\\n\\r\\nWrite-Host \\\"‚úÖ Host remediation complete for: $hostname\\\"\\r\\n```\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"HostName\",\"comparison\":\"isNotEqualTo\"},\"name\":\"HostRemediation\"}]},\"conditionalVisibility\":{\"parameterName\":\"entityTab\",\"comparison\":\"isEqualTo\",\"value\":\"Host\"},\"name\":\"HostInvestigation\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"ip-address\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IPAddress\",\"label\":\"IP Address\",\"type\":1,\"description\":\"Enter IP address to investigate\",\"value\":\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"IPParams\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union\\r\\n(CommonSecurityLog | where SourceIP == \\\"{IPAddress}\\\" or DestinationIP == \\\"{IPAddress}\\\"),\\r\\n(SigninLogs | where IPAddress == \\\"{IPAddress}\\\"),\\r\\n(AzureActivity | where CallerIpAddress == \\\"{IPAddress}\\\")\\r\\n| where TimeGenerated {TimeRange}\\r\\n| project TimeGenerated, Type, Activity = coalesce(Activity, OperationNameValue, \\\"Sign-in\\\"), User = coalesce(SourceUserName, UserPrincipalName, Caller)\\r\\n| order by TimeGenerated desc\\r\\n| take 100\",\"size\":0,\"title\":\"Activity from IP: {IPAddress}\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"IPAddress\",\"comparison\":\"isNotEqualTo\"},\"name\":\"IPActivity\"},{\"type\":1,\"content\":{\"json\":\"### üîß IP Address Remediation Actions\\r\\n\\r\\n```powershell\\r\\n# IP Address: {IPAddress}\\r\\n$ipAddress = \\\"{IPAddress}\\\"\\r\\n$bearerToken = \\\"{BearerToken}\\\"\\r\\n$headers = @{\\r\\n    \\\"Authorization\\\" = \\\"Bearer $bearerToken\\\"\\r\\n    \\\"Content-Type\\\" = \\\"application/json\\\"\\r\\n}\\r\\n\\r\\n# === MICROSOFT DEFENDER FOR ENDPOINT ===\\r\\n# Create Custom Indicator\\r\\n$mdeUri = \\\"https://api.securitycenter.microsoft.com/api/indicators\\\"\\r\\n$mdeBody = @{\\r\\n    indicatorValue = $ipAddress\\r\\n    indicatorType = \\\"IpAddress\\\"\\r\\n    action = \\\"Block\\\"\\r\\n    title = \\\"Blocked IP - Security Incident\\\"\\r\\n    description = \\\"Automated block from Sentinel360\\\"\\r\\n    severity = \\\"High\\\"\\r\\n    recommendedActions = \\\"Investigate source of traffic\\\"\\r\\n} | ConvertTo-Json\\r\\nInvoke-RestMethod -Uri $mdeUri -Headers $headers -Method POST -Body $mdeBody\\r\\n\\r\\n# === AZURE FIREWALL ===\\r\\n# Add to IP Group\\r\\n$ipGroupUri = \\\"https://management.azure.com/subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.Network/ipGroups/BlockedIPs?api-version=2021-02-01\\\"\\r\\n$ipGroup = Invoke-RestMethod -Uri $ipGroupUri -Headers $headers -Method GET\\r\\n$ipGroup.properties.ipAddresses += $ipAddress\\r\\n$updateBody = $ipGroup | ConvertTo-Json -Depth 10\\r\\nInvoke-RestMethod -Uri $ipGroupUri -Headers $headers -Method PUT -Body $updateBody\\r\\n\\r\\n# === AZURE WAF ===\\r\\n# Add Custom Rule\\r\\n$wafUri = \\\"https://management.azure.com/subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies/{wafPolicy}?api-version=2021-02-01\\\"\\r\\n$wafPolicy = Invoke-RestMethod -Uri $wafUri -Headers $headers -Method GET\\r\\n$customRule = @{\\r\\n    name = \\\"BlockIP_$($ipAddress.Replace('.','_'))\\\"\\r\\n    priority = 100\\r\\n    ruleType = \\\"MatchRule\\\"\\r\\n    matchConditions = @(\\r\\n        @{\\r\\n            matchVariables = @(@{variableName = \\\"RemoteAddr\\\"})\\r\\n            operator = \\\"IPMatch\\\"\\r\\n            matchValues = @($ipAddress)\\r\\n        }\\r\\n    )\\r\\n    action = \\\"Block\\\"\\r\\n}\\r\\n$wafPolicy.properties.customRules += $customRule\\r\\n$wafUpdateBody = $wafPolicy | ConvertTo-Json -Depth 10\\r\\nInvoke-RestMethod -Uri $wafUri -Headers $headers -Method PUT -Body $wafUpdateBody\\r\\n\\r\\n# === CONDITIONAL ACCESS ===\\r\\n# Add to Named Location\\r\\n$locationUri = \\\"https://graph.microsoft.com/v1.0/identity/conditionalAccess/namedLocations\\\"\\r\\n$locationBody = @{\\r\\n    \\\"@odata.type\\\" = \\\"#microsoft.graph.ipNamedLocation\\\"\\r\\n    displayName = \\\"Blocked IPs - Security Incident\\\"\\r\\n    isTrusted = $false\\r\\n    ipRanges = @(\\r\\n        @{\\r\\n            \\\"@odata.type\\\" = \\\"#microsoft.graph.iPv4CidrRange\\\"\\r\\n            cidrAddress = \\\"$ipAddress/32\\\"\\r\\n        }\\r\\n    )\\r\\n} | ConvertTo-Json -Depth 10\\r\\nInvoke-RestMethod -Uri $locationUri -Headers $headers -Method POST -Body $locationBody\\r\\n\\r\\nWrite-Host \\\"‚úÖ IP blocking complete for: $ipAddress\\\"\\r\\n```\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"IPAddress\",\"comparison\":\"isNotEqualTo\"},\"name\":\"IPRemediation\"}]},\"conditionalVisibility\":{\"parameterName\":\"entityTab\",\"comparison\":\"isEqualTo\",\"value\":\"IP\"},\"name\":\"IPInvestigation\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"EntityInsights\"},\"name\":\"EntityInsightsTab\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## üìã Microsoft Defender XDR Audit Events\"},\"name\":\"AuditHeader\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CloudAppEvents\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where Application has_any (\\\"Microsoft Defender\\\", \\\"Microsoft 365 Defender\\\", \\\"Microsoft Defender for Endpoint\\\", \\\"Microsoft Defender for Office 365\\\", \\\"Office 365\\\")\\r\\n| extend \\r\\n    User = coalesce(AccountDisplayName, tostring(AccountObjectId), \\\"Unknown\\\"),\\r\\n    AppUsed = Application,\\r\\n    Action = ActionType,\\r\\n    IP = tostring(IPAddress)\\r\\n| project \\r\\n    TimeGenerated,\\r\\n    User,\\r\\n    AppUsed,\\r\\n    Action,\\r\\n    IP\\r\\n| order by TimeGenerated desc\\r\\n| take 500\",\"size\":0,\"title\":\"XDR Audit Events\",\"showRefreshButton\":true,\"showExportToExcel\":true,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Action\",\"formatter\":5},{\"columnMatch\":\"AppUsed\",\"formatter\":5}],\"filter\":true}},\"name\":\"XDRAuditGrid\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"XDRAudit\"},\"name\":\"XDRAuditTab\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourcegroups/sentinel360-xdr/providers/microsoft.operationalinsights/workspaces/sentinel360-mssp\"],\"fromTemplateId\":\"sentinel-sentinel360-xdr-ultimate\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}