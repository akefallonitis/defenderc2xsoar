{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "DefenderC2 Advanced Console ",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourcegroups/sentinel360/providers/microsoft.operationalinsights/workspaces/sentinel360-mssp",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# üéØ DefenderC2 Command & Control Console\\n## Fully Automated Async Polling with MDE Integration\",\"style\":\"error\"},\"name\":\"header\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"refresh-interval\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RefreshInterval\",\"label\":\"Auto Refresh\",\"type\":2,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\":\\\"30000\\\",\\\"label\\\":\\\"üü¢ 30 seconds\\\"},{\\\"value\\\":\\\"60000\\\",\\\"label\\\":\\\"üü° 1 minute\\\"},{\\\"value\\\":\\\"300000\\\",\\\"label\\\":\\\"üîµ 5 minutes\\\"},{\\\"value\\\":\\\"0\\\",\\\"label\\\":\\\"üî¥ Manual\\\"}]\",\"value\":\"30000\"},{\"id\":\"api-endpoint\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ApiEndpoint\",\"label\":\"MDE API Endpoint\",\"type\":2,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\":\\\"/api/machines\\\",\\\"label\\\":\\\"üìä List Machines\\\"},{\\\"value\\\":\\\"/api/alerts\\\",\\\"label\\\":\\\"üö® List Alerts\\\"},{\\\"value\\\":\\\"/api/vulnerabilities/machinesVulnerabilities\\\",\\\"label\\\":\\\"üîç Vulnerabilities\\\"},{\\\"value\\\":\\\"/api/indicators\\\",\\\"label\\\":\\\"üìç Indicators\\\"}]\",\"value\":\"/api/machines\"},{\"id\":\"response-url-param\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ResponseOutputsUrl\",\"type\":1,\"isHiddenWhenLocked\":true,\"value\":\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"params\"},{\"type\":1,\"content\":{\"json\":\"---\\n### üöÄ Step 1: Trigger Logic App Execution\",\"style\":\"info\"},\"name\":\"step1-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":\\\"{\\\\r\\\\n  \\\\\\\"apiType\\\\\\\": \\\\\\\"MDE\\\\\\\",\\\\r\\\\n  \\\\\\\"method\\\\\\\": \\\\\\\"GET\\\\\\\",\\\\r\\\\n  \\\\\\\"endpoint\\\\\\\": \\\\\\\"{ApiEndpoint}\\\\\\\",\\\\r\\\\n  \\\\\\\"tenantId\\\\\\\": \\\\\\\"188e61b4-5905-4f81-b1c3-03826208e51a\\\\\\\",\\\\r\\\\n  \\\\\\\"clientId\\\\\\\": \\\\\\\"f342ec45-5669-45fd-9768-3a6a246061ac\\\\\\\",\\\\r\\\\n  \\\\\\\"clientSecret\\\\\\\": \\\\\\\"ocs8Q~Jg1HuhS0hTGSypUzNzsvY5xRVrUUGIzakN\\\\\\\"\\\\r\\\\n}\\\",\\\"headers\\\":[{\\\"key\\\":\\\"Content-Type\\\",\\\"value\\\":\\\"application/json\\\"}],\\\"method\\\":\\\"POST\\\",\\\"url\\\":\\\"https://prod-89.eastus.logic.azure.com:443/workflows/c1f8a5e6e621419cb4c8314feff6e129/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vEnqCPCFOpPs4sQ_ilwZ7W9CKaoUCfj08J8iUuwf5SU\\\",\\\"contentType\\\":\\\"application/json\\\",\\\"urlParams\\\":[],\\\"transformers\\\":null}\",\"size\":4,\"title\":\"Trigger Status (Endpoint: {ApiEndpoint})\",\"queryType\":10,\"visualization\":\"table\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"status\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"timestamp\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}}}},\"name\":\"trigger\"},{\"type\":1,\"content\":{\"json\":\"---\\n### ‚è≥ Step 2: Poll for Completion & Extract Response URL\",\"style\":\"info\"},\"name\":\"step2-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourceGroups/Sentinel360-XDR/providers/Microsoft.Logic/workflows/DefenderGraphUniversal-API-Proxy/runs\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2016-06-01\\\"},{\\\"key\\\":\\\"$top\\\",\\\"value\\\":\\\"1\\\"},{\\\"key\\\":\\\"$filter\\\",\\\"value\\\":\\\"status eq 'Succeeded'\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value[0]\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.status\\\",\\\"columnid\\\":\\\"Status\\\"},{\\\"path\\\":\\\"$.properties.startTime\\\",\\\"columnid\\\":\\\"StartTime\\\"},{\\\"path\\\":\\\"$.name\\\",\\\"columnid\\\":\\\"RunId\\\"},{\\\"path\\\":\\\"$.properties.response.outputsLink.uri\\\",\\\"columnid\\\":\\\"OutputsUrl\\\"}]}}]}\",\"size\":0,\"title\":\"üìã Latest Successful Run (Auto-refresh: 5s)\",\"exportFieldName\":\"OutputsUrl\",\"exportParameterName\":\"ResponseOutputsUrl\",\"queryType\":12,\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"green\",\"text\":\"‚úÖ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Running\",\"representation\":\"orange\",\"text\":\"‚è≥ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"red\",\"text\":\"‚ùå {0}\"}]}},{\"columnMatch\":\"StartTime\",\"formatter\":6},{\"columnMatch\":\"OutputsUrl\",\"formatter\":5}]}},\"name\":\"poll-status\"},{\"type\":1,\"content\":{\"json\":\"---\\n### üì• Step 3: Fetch & Parse MDE Response Data\",\"style\":\"info\"},\"name\":\"step3-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"CustomEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"url\\\":\\\"{ResponseOutputsUrl}\\\",\\\"urlParams\\\":[],\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.body.data.value[*]\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.computerDnsName\\\",\\\"columnid\\\":\\\"MachineName\\\"},{\\\"path\\\":\\\"$.osPlatform\\\",\\\"columnid\\\":\\\"Platform\\\"},{\\\"path\\\":\\\"$.osVersion\\\",\\\"columnid\\\":\\\"OS\\\"},{\\\"path\\\":\\\"$.healthStatus\\\",\\\"columnid\\\":\\\"Health\\\"},{\\\"path\\\":\\\"$.riskScore\\\",\\\"columnid\\\":\\\"Risk\\\"},{\\\"path\\\":\\\"$.exposureLevel\\\",\\\"columnid\\\":\\\"Exposure\\\"},{\\\"path\\\":\\\"$.lastIpAddress\\\",\\\"columnid\\\":\\\"IP\\\"},{\\\"path\\\":\\\"$.lastExternalIpAddress\\\",\\\"columnid\\\":\\\"ExternalIP\\\"},{\\\"path\\\":\\\"$.rbacGroupName\\\",\\\"columnid\\\":\\\"Group\\\"},{\\\"path\\\":\\\"$.onboardingStatus\\\",\\\"columnid\\\":\\\"Onboarding\\\"},{\\\"path\\\":\\\"$.lastSeen\\\",\\\"columnid\\\":\\\"LastSeen\\\"},{\\\"path\\\":\\\"$.id\\\",\\\"columnid\\\":\\\"MachineId\\\"},{\\\"path\\\":\\\"$.agentVersion\\\",\\\"columnid\\\":\\\"AgentVersion\\\"},{\\\"path\\\":\\\"$.machineTags\\\",\\\"columnid\\\":\\\"Tags\\\"}]}}]}\",\"size\":0,\"title\":\"üñ•Ô∏è MDE Data - {ApiEndpoint} (Auto-refresh: 10s)\",\"noDataMessage\":\"Waiting for Logic App to complete... URL will be populated automatically.\",\"queryType\":10,\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MachineName\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20%\"}},{\"columnMatch\":\"Health\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Active\",\"representation\":\"green\",\"text\":\"‚úÖ Active\"},{\"operator\":\"==\",\"thresholdValue\":\"Inactive\",\"representation\":\"yellow\",\"text\":\"‚ö†Ô∏è Inactive\"},{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"‚ùì {0}\"}]}},{\"columnMatch\":\"Risk\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"None\",\"representation\":\"green\",\"text\":\"‚úÖ None\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"‚ö†Ô∏è Low\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"‚ö†Ô∏è Medium\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"red\",\"text\":\"‚ùå High\"},{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"{0}\"}]}},{\"columnMatch\":\"Exposure\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"None\",\"representation\":\"green\",\"text\":\"‚úÖ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"yellow\",\"text\":\"‚ö†Ô∏è {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"orange\",\"text\":\"‚ö†Ô∏è {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"red\",\"text\":\"‚ùå {0}\"},{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"{0}\"}]}},{\"columnMatch\":\"Onboarding\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Onboarded\",\"representation\":\"green\",\"text\":\"‚úÖ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"CanBeOnboarded\",\"representation\":\"yellow\",\"text\":\"‚ö†Ô∏è Ready\"},{\"operator\":\"==\",\"thresholdValue\":\"InsufficientInfo\",\"representation\":\"orange\",\"text\":\"‚ùì Insufficient\"},{\"operator\":\"Default\",\"representation\":\"gray\",\"text\":\"{0}\"}]}},{\"columnMatch\":\"LastSeen\",\"formatter\":6},{\"columnMatch\":\"MachineId\",\"formatter\":5},{\"columnMatch\":\"Tags\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"15%\"}}],\"sortBy\":[{\"itemKey\":\"LastSeen\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"MachineName\",\"label\":\"Machine Name\"},{\"columnId\":\"Platform\",\"label\":\"Platform\"},{\"columnId\":\"OS\",\"label\":\"OS Version\"},{\"columnId\":\"Health\",\"label\":\"Health\"},{\"columnId\":\"Risk\",\"label\":\"Risk Score\"},{\"columnId\":\"Exposure\",\"label\":\"Exposure\"},{\"columnId\":\"IP\",\"label\":\"Internal IP\"},{\"columnId\":\"ExternalIP\",\"label\":\"External IP\"},{\"columnId\":\"Group\",\"label\":\"RBAC Group\"},{\"columnId\":\"Onboarding\",\"label\":\"Status\"},{\"columnId\":\"LastSeen\",\"label\":\"Last Seen\"},{\"columnId\":\"MachineId\",\"label\":\"Machine ID\"},{\"columnId\":\"AgentVersion\",\"label\":\"Agent Ver\"},{\"columnId\":\"Tags\",\"label\":\"Tags\"}]},\"sortBy\":[{\"itemKey\":\"LastSeen\",\"sortOrder\":2}]},\"conditionalVisibility\":{\"parameterName\":\"ResponseOutputsUrl\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"name\":\"mde-data\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"data\\\":null,\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourceGroups/Sentinel360-XDR/providers/Microsoft.Logic/workflows/DefenderGraphUniversal-API-Proxy/runs\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2016-06-01\\\"},{\\\"key\\\":\\\"$top\\\",\\\"value\\\":\\\"10\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value[*]\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.status\\\",\\\"columnid\\\":\\\"Status\\\"},{\\\"path\\\":\\\"$.properties.startTime\\\",\\\"columnid\\\":\\\"StartTime\\\"},{\\\"path\\\":\\\"$.properties.endTime\\\",\\\"columnid\\\":\\\"EndTime\\\"},{\\\"path\\\":\\\"$.properties.correlation.clientTrackingId\\\",\\\"columnid\\\":\\\"TrackingId\\\"},{\\\"path\\\":\\\"$.name\\\",\\\"columnid\\\":\\\"RunId\\\"}]}}]}\",\"size\":4,\"title\":\"üìä Logic App Run History (Last 10)\",\"queryType\":12,\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Succeeded\",\"representation\":\"green\",\"text\":\"‚úÖ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Running\",\"representation\":\"orange\",\"text\":\"‚è≥ {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Failed\",\"representation\":\"red\",\"text\":\"‚ùå {0}\"},{\"operator\":\"==\",\"thresholdValue\":\"Cancelled\",\"representation\":\"gray\",\"text\":\"‚õî {0}\"}]}},{\"columnMatch\":\"StartTime\",\"formatter\":6},{\"columnMatch\":\"EndTime\",\"formatter\":6},{\"columnMatch\":\"RunId\",\"formatter\":5}],\"sortBy\":[{\"itemKey\":\"StartTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"StartTime\",\"sortOrder\":2}]},\"name\":\"run-history\"},{\"type\":1,\"content\":{\"json\":\"---\\n### üîÑ Architecture Overview\\n\\n**Flow:**\\n1. **Trigger** ‚Üí Sends API request to Logic App with MDE endpoint\\n2. **Logic App** ‚Üí Authenticates with multi-tenant app registration & calls MDE API\\n3. **Poll** ‚Üí Monitors Logic App runs until 'Succeeded' status\\n4. **Extract** ‚Üí Gets OutputsLink URL from successful run\\n5. **Fetch** ‚Üí Retrieves and parses MDE response data\\n\\n**Key Features:**\\n- ‚úÖ Fully automated parameter passing\\n- ‚úÖ No manual URL copying required\\n- ‚úÖ Handles async Logic App execution\\n- ‚úÖ Multiple MDE endpoints supported\\n- ‚úÖ Auto-refresh at different intervals\\n- ‚úÖ CORS bypass via Logic App proxy\\n\\n**Refresh Intervals:**\\n- Trigger: User configurable (30s/1m/5m)\\n- Polling: 5 seconds (fast status check)\\n- Data Fetch: 10 seconds (after URL available)\\n\\n---\\n### üõ†Ô∏è Configuration\\n- **Logic App:** DefenderGraphUniversal-API-Proxy\\n- **Tenant:** MSSP (188e61b4-5905-4f81-b1c3-03826208e51a)\\n- **Client ID:** f342ec45-5669-45fd-9768-3a6a246061ac\",\"style\":\"info\"},\"name\":\"footer\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/9a7f80d9-6851-4e94-877c-993baf7ffb88/resourcegroups/sentinel360/providers/microsoft.operationalinsights/workspaces/sentinel360-mssp\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}