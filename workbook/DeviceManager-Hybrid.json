{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# üñ•Ô∏è DefenderC2 Device Manager - Hybrid\n\n## Multi-Tenant Defender XDR Management (Hybrid Version)\n\n**User:** akefallonitis | **Last Updated:** 2025-10-16 00:00:00 UTC\n\n> This hybrid version uses **ARM Actions** for executing machine actions and **CustomEndpoint** for auto-refreshing data queries"
      },
      "name": "header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "function-app",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionApp",
            "label": "DefenderC2 Function App",
            "type": 5,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where type == 'microsoft.web/sites' and kind == 'functionapp' | project id, name, resourceGroup, subscriptionId | order by name asc",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "subscription-id",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "resource-group",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = resourceGroup",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "function-name",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionAppName",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = name",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "tenant-id",
            "version": "KqlParameterItem/1.0",
            "name": "TenantId",
            "label": "Defender XDR Tenant",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "query": "ResourceContainers | where type == 'microsoft.resources/subscriptions' | project tenantId | distinct tenantId | project value = tenantId, label = strcat('üè¢ ', tenantId) | order by label asc",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "selectFirstItem": true,
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "defaultValue": "value::1"
          },
          {
            "id": "device-list",
            "version": "KqlParameterItem/1.0",
            "name": "DeviceList",
            "label": "üíª Select Devices",
            "type": 2,
            "isGlobal": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"body\":null,\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Devices\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.devices[*]\",\"columns\":[{\"path\":\"$.id\",\"columnid\":\"value\"},{\"path\":\"$.computerDnsName\",\"columnid\":\"label\"}]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 10,
            "description": "‚úÖ Auto-populated from Defender XDR",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              },
              {
                "criterionType": "param",
                "value": "{FunctionAppName}"
              },
              {
                "criterionType": "param",
                "value": "{TenantId}"
              }
            ]
          },
          {
            "id": "scan-type",
            "version": "KqlParameterItem/1.0",
            "name": "ScanType",
            "label": "Scan Type",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\":\"Quick\",\"label\":\"Quick Scan\"},{\"value\":\"Full\",\"label\":\"Full Scan\"}]",
            "value": "Quick"
          },
          {
            "id": "isolation-type",
            "version": "KqlParameterItem/1.0",
            "name": "IsolationType",
            "label": "Isolation Type",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\":\"Full\",\"label\":\"Full Isolation\"},{\"value\":\"Selective\",\"label\":\"Selective Isolation\"}]",
            "value": "Full"
          },
          {
            "id": "action-id-track",
            "version": "KqlParameterItem/1.0",
            "name": "ActionIdToTrack",
            "label": "üîç Track Action ID",
            "type": 1,
            "isGlobal": true,
            "description": "Click on an Action ID below to auto-populate"
          },
          {
            "id": "action-id-cancel",
            "version": "KqlParameterItem/1.0",
            "name": "ActionIdToCancel",
            "label": "‚ùå Cancel Action ID",
            "type": 1,
            "isGlobal": true,
            "description": "Click on an Action ID below to auto-populate"
          },
          {
            "id": "auto-refresh",
            "version": "KqlParameterItem/1.0",
            "name": "AutoRefreshInterval",
            "label": "üîÑ Auto Refresh",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\":\"0\",\"label\":\"Off\"},{\"value\":\"30000\",\"label\":\"30 seconds\"},{\"value\":\"60000\",\"label\":\"1 minute\"},{\"value\":\"300000\",\"label\":\"5 minutes\"}]",
            "value": "30000"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "‚ö†Ô∏è Pending Actions Warning",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get All Actions\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"filter\",\"value\":\"status eq 'Pending'\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.actions[*]\",\"columns\":[{\"path\":\"$.machineId\",\"columnid\":\"MachineId\"},{\"path\":\"$.type\",\"columnid\":\"ActionType\"},{\"path\":\"$.id\",\"columnid\":\"ActionId\"}]}}]}",
              "size": 0,
              "noDataMessage": "‚úÖ No pending actions - safe to proceed",
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "AutoRefreshInterval",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "MachineId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ActionType",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "pending",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "rowLimit": 50,
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "MachineId",
                    "label": "Device ID"
                  },
                  {
                    "columnId": "ActionType",
                    "label": "Pending Action Type"
                  },
                  {
                    "columnId": "ActionId",
                    "label": "Action ID"
                  }
                ]
              }
            },
            "customWidth": "100",
            "name": "pending-actions-check"
          },
          {
            "type": 1,
            "content": {
              "json": "‚ö†Ô∏è **WARNING:** Attempting to run the same action on a device that already has a pending action of the same type will result in a **400 Bad Request** error.\n\n**Before executing:**\n1. Check the table above for pending actions on your selected devices\n2. Wait for pending actions to complete or cancel them\n3. Ensure you're not duplicating a pending action"
            },
            "name": "warning-text"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "DeviceList",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "pending-actions-warning"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "üéØ Machine Actions (ARM Actions)",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "**Selected Devices:** {DeviceList}\n\n**Timestamp:** 2025-10-16 00:00:00 UTC | **User:** akefallonitis\n\n---\n\nClick on an action button below to execute. All actions use ARM API for reliable execution."
            },
            "name": "action-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "scan-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîç Run Antivirus Scan ({ScanType})",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Run Antivirus Scan\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"scanType\":\"{ScanType}\",\"comment\":\"Scan via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Run Antivirus Scan",
                    "description": "This will initiate an antivirus scan on selected devices",
                    "actionName": "run-scan",
                    "runLabel": "üîç Start Scan"
                  }
                },
                {
                  "id": "isolate-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîí Isolate Devices ({IsolationType})",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Isolate Device\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"isolationType\":\"{IsolationType}\",\"comment\":\"Isolated via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Isolate Devices",
                    "description": "This will isolate the selected devices from network",
                    "actionName": "isolate-devices",
                    "runLabel": "üîí Isolate Now"
                  }
                },
                {
                  "id": "unisolate-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîì Unisolate Devices",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Unisolate Device\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"comment\":\"Unisolated via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Unisolate Devices",
                    "description": "This will remove isolation from selected devices",
                    "actionName": "unisolate-devices",
                    "runLabel": "üîì Unisolate Now"
                  }
                },
                {
                  "id": "collect-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üì¶ Collect Investigation Package",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Collect Investigation Package\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"comment\":\"Investigation package via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Collect Investigation Package",
                    "description": "This will collect forensic investigation packages from selected devices",
                    "actionName": "collect-package",
                    "runLabel": "üì¶ Collect Now"
                  }
                },
                {
                  "id": "restrict-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Restrict App Execution",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Restrict App Execution\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"comment\":\"Restricted via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Restrict App Execution",
                    "description": "This will restrict app execution on selected devices",
                    "actionName": "restrict-apps",
                    "runLabel": "üö´ Restrict Now"
                  }
                },
                {
                  "id": "unrestrict-action",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚úÖ Unrestrict App Execution",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/functions/DefenderC2Dispatcher/invoke",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2022-03-01"
                      }
                    ],
                    "body": "{\"action\":\"Unrestrict App Execution\",\"tenantId\":\"{TenantId}\",\"deviceIds\":\"{DeviceList}\",\"comment\":\"Unrestricted via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}",
                    "httpMethod": "POST",
                    "title": "Unrestrict App Execution",
                    "description": "This will unrestrict app execution on selected devices",
                    "actionName": "unrestrict-apps",
                    "runLabel": "‚úÖ Unrestrict Now"
                  }
                }
              ]
            },
            "name": "arm-actions"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "DeviceList",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "machine-actions-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "üìä Machine Actions - All Pending/Running",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get All Actions\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"filter\",\"value\":\"status eq 'Pending' or status eq 'InProgress'\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.actions[*]\",\"columns\":[{\"path\":\"$.id\",\"columnid\":\"ActionId\"},{\"path\":\"$.type\",\"columnid\":\"Type\"},{\"path\":\"$.machineId\",\"columnid\":\"MachineId\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.requestor\",\"columnid\":\"Requestor\"},{\"path\":\"$.creationDateTimeUtc\",\"columnid\":\"Created\"}]}}]}",
              "size": 0,
              "title": "Currently Running Actions (Auto-refreshing every {AutoRefreshInterval}ms)",
              "noDataMessage": "No pending or running actions",
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "AutoRefreshInterval",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ActionId",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "üìã {0}"
                    }
                  },
                  {
                    "columnMatch": "Type",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Isolate",
                          "representation": "lock",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Scan",
                          "representation": "search",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "gear",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "inProgress",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "info",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "rowLimit": 100,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Created",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ActionId",
                    "label": "Action ID (Click to copy)"
                  },
                  {
                    "columnId": "Type",
                    "label": "Action Type"
                  },
                  {
                    "columnId": "MachineId",
                    "label": "Device ID"
                  },
                  {
                    "columnId": "Status",
                    "label": "Status"
                  },
                  {
                    "columnId": "Requestor",
                    "label": "Requested By"
                  },
                  {
                    "columnId": "Created",
                    "label": "Created (UTC)"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Created",
                  "sortOrder": 2
                }
              ]
            },
            "name": "running-actions"
          }
        ]
      },
      "name": "running-actions-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "üìã Machine Actions History - All Actions",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get All Actions\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.actions[*]\",\"columns\":[{\"path\":\"$.id\",\"columnid\":\"ActionId\"},{\"path\":\"$.type\",\"columnid\":\"Type\"},{\"path\":\"$.machineId\",\"columnid\":\"MachineId\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.requestor\",\"columnid\":\"Requestor\"},{\"path\":\"$.creationDateTimeUtc\",\"columnid\":\"Created\"},{\"path\":\"$.lastUpdateDateTimeUtc\",\"columnid\":\"LastUpdate\"},{\"path\":\"$.errorHResult\",\"columnid\":\"Error\"}]}}]}",
              "size": 0,
              "title": "All Machine Actions (Last 100, Auto-refreshing)",
              "noDataMessage": "No machine actions found",
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "AutoRefreshInterval",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ActionId",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "üìã {0}"
                    }
                  },
                  {
                    "columnMatch": "Type",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Isolate",
                          "representation": "lock",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Unisolate",
                          "representation": "unlock",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Scan",
                          "representation": "search",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Collect",
                          "representation": "archive",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Restrict",
                          "representation": "blocked",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "gear",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Failed",
                          "representation": "failed",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "inProgress",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Cancelled",
                          "representation": "cancelled",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "info",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Error",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "isNotNull",
                          "thresholdValue": null,
                          "representation": "redBright",
                          "text": "‚ùå Error"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "green",
                          "text": "‚úÖ OK"
                        }
                      ]
                    }
                  }
                ],
                "rowLimit": 100,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Created",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ActionId",
                    "label": "Action ID (Click to copy)"
                  },
                  {
                    "columnId": "Type",
                    "label": "Action Type"
                  },
                  {
                    "columnId": "MachineId",
                    "label": "Device ID"
                  },
                  {
                    "columnId": "Status",
                    "label": "Status"
                  },
                  {
                    "columnId": "Requestor",
                    "label": "Requested By"
                  },
                  {
                    "columnId": "Created",
                    "label": "Created (UTC)"
                  },
                  {
                    "columnId": "LastUpdate",
                    "label": "Last Updated (UTC)"
                  },
                  {
                    "columnId": "Error",
                    "label": "Error Status"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Created",
                  "sortOrder": 2
                }
              ]
            },
            "name": "all-actions-history"
          }
        ]
      },
      "name": "actions-history-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "üîç Track Action Status (CustomEndpoint)",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "Enter an Action ID in the parameter above or click on an Action ID from the tables to track its status."
            },
            "name": "track-instructions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Action Status\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"actionId\",\"value\":\"{ActionIdToTrack}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.actionStatus.id\",\"columnid\":\"ActionId\"},{\"path\":\"$.actionStatus.type\",\"columnid\":\"Type\"},{\"path\":\"$.actionStatus.status\",\"columnid\":\"Status\"},{\"path\":\"$.actionStatus.machineId\",\"columnid\":\"MachineId\"},{\"path\":\"$.actionStatus.requestor\",\"columnid\":\"Requestor\"},{\"path\":\"$.actionStatus.creationDateTimeUtc\",\"columnid\":\"Created\"},{\"path\":\"$.actionStatus.lastUpdateDateTimeUtc\",\"columnid\":\"LastUpdate\"},{\"path\":\"$.actionStatus.errorHResult\",\"columnid\":\"Error\"}]}}]}",
              "size": 0,
              "title": "Action Status for: {ActionIdToTrack}",
              "noDataMessage": "Enter an Action ID to track",
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "AutoRefreshInterval",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Failed",
                          "representation": "failed",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "inProgress",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Cancelled",
                          "representation": "cancelled",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "info",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Error",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "isNotNull",
                          "thresholdValue": null,
                          "representation": "redBright",
                          "text": "‚ùå {0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "action-status-result"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "ActionIdToTrack",
        "comparison": "isNotEqualTo"
      },
      "name": "track-action-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "‚ùå Cancel Action (CustomEndpoint)",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "Enter an Action ID in the parameter above or click on a Pending Action ID from the tables to cancel it."
            },
            "name": "cancel-instructions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Cancel Action\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"actionId\",\"value\":\"{ActionIdToCancel}\"},{\"key\":\"comment\",\"value\":\"Cancelled via DefenderC2 Workbook by akefallonitis at 2025-10-16 00:00:00 UTC\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"},{\"path\":\"$.error\",\"columnid\":\"Error\"}]}}]}",
              "size": 0,
              "title": "Cancel Action: {ActionIdToCancel}",
              "noDataMessage": "Enter an Action ID to cancel",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Initiated",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Unknown",
                          "representation": "error",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "info",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Error",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "isNotNull",
                          "thresholdValue": null,
                          "representation": "redBright",
                          "text": "‚ùå {0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "cancel-action-result"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "ActionIdToCancel",
        "comparison": "isNotEqualTo"
      },
      "name": "cancel-action-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "üíª Device Inventory (CustomEndpoint)",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Devices\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.devices[*]\",\"columns\":[{\"path\":\"$.computerDnsName\",\"columnid\":\"DeviceName\"},{\"path\":\"$.id\",\"columnid\":\"DeviceId\"},{\"path\":\"$.riskScore\",\"columnid\":\"RiskScore\"},{\"path\":\"$.healthStatus\",\"columnid\":\"HealthStatus\"},{\"path\":\"$.osPlatform\",\"columnid\":\"OS\"},{\"path\":\"$.lastIpAddress\",\"columnid\":\"LastIP\"},{\"path\":\"$.lastSeen\",\"columnid\":\"LastSeen\"}]}}]}",
              "size": 0,
              "title": "All Devices (Auto-refreshing)",
              "noDataMessage": "No devices found",
              "timeContext": {
                "durationMs": 86400000
              },
              "timeContextFromParameter": "AutoRefreshInterval",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DeviceId",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "üìã Copy"
                    }
                  },
                  {
                    "columnMatch": "RiskScore",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü° {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "gray",
                          "text": "{0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "HealthStatus",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Active",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Inactive",
                          "representation": "disabled",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "warning",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "rowLimit": 100,
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "RiskScore",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "DeviceName",
                    "label": "Device Name"
                  },
                  {
                    "columnId": "DeviceId",
                    "label": "Device ID"
                  },
                  {
                    "columnId": "RiskScore",
                    "label": "Risk Score"
                  },
                  {
                    "columnId": "HealthStatus",
                    "label": "Health Status"
                  },
                  {
                    "columnId": "OS",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "LastIP",
                    "label": "Last IP Address"
                  },
                  {
                    "columnId": "LastSeen",
                    "label": "Last Seen"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RiskScore",
                  "sortOrder": 2
                }
              ]
            },
            "name": "device-inventory"
          }
        ]
      },
      "name": "device-inventory-group"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/80110e3c-3ec4-4567-b06d-7d47a72562f5/resourcegroups/alex-testing-rg"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
