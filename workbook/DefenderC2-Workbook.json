{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# üõ°Ô∏è DefenderC2 Complete Command & Control Workbook\n\n## üöÄ Comprehensive Microsoft Defender XDR Operations Center\n\n### ‚ú® Complete Feature Set:\n- üñ•Ô∏è **Device Management** - Full control with ARM actions + auto-refresh monitoring\n- üéÆ **Live Response Console** - Interactive shell with command execution\n- üìö **File Library** - Upload/download files with Azure Storage integration\n- üîç **Advanced Hunting** - KQL query console with saved queries\n- üõ°Ô∏è **Threat Intelligence** - Manage indicators (files, IPs, URLs, domains)\n- üö® **Incident Management** - View and manage security incidents\n- üéØ **Custom Detections** - Create and manage detection rules\n- üìä **Dashboard** - Real-time overview and quick actions\n\n### üéØ Design Principles:\n- ‚úÖ **CustomEndpoint for Listing** - Auto-refresh monitoring\n- ‚úÖ **ARM Actions for Execution** - RBAC-controlled operations\n- ‚úÖ **Conditional Visibility** - Tab-specific functionality\n- ‚úÖ **Auto-population** - Smart parameter defaults\n- ‚úÖ **Console-like UX** - Terminal-style interfaces\n\n---\n\n**Navigation:** Use the tabs above to access different modules  \n**Quick Start:** Select your Function App and Tenant below to begin"
      },
      "name": "main-header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "main-tab",
            "version": "KqlParameterItem/1.0",
            "name": "MainTab",
            "label": "üß≠ Module",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\": \"dashboard\", \"label\": \"üìä Dashboard\"}, {\"value\": \"devices\", \"label\": \"üñ•Ô∏è Device Management\"}, {\"value\": \"liveresponse\", \"label\": \"üéÆ Live Response Console\"}, {\"value\": \"library\", \"label\": \"üìö File Library\"}, {\"value\": \"hunting\", \"label\": \"üîç Advanced Hunting\"}, {\"value\": \"threatintel\", \"label\": \"üõ°Ô∏è Threat Intelligence\"}, {\"value\": \"incidents\", \"label\": \"üö® Incident Management\"}, {\"value\": \"detections\", \"label\": \"üéØ Custom Detections\"}]",
            "value": "dashboard"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "main-tab-selector"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "fa",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionApp",
            "label": "‚öôÔ∏è DefenderC2 Function App",
            "type": 5,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where type == 'microsoft.web/sites' and kind == 'functionapp' | project id, name, resourceGroup, subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false,
              "resourceTypeFilter": {
                "microsoft.web/sites": true
              }
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "sub",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "rg",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = resourceGroup",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "fn",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionAppName",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = name",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "tid",
            "version": "KqlParameterItem/1.0",
            "name": "TenantId",
            "label": "üåê Defender XDR Tenant",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "query": "ResourceContainers | where type == 'microsoft.resources/subscriptions' | project tenantId | distinct tenantId | project value = tenantId, label = strcat('Tenant: ', tenantId)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "selectFirstItem": true,
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": "a92a42cd-bf8c-46ba-aa4e-64cbc9e030d9"
          },
          {
            "id": "ref",
            "version": "KqlParameterItem/1.0",
            "name": "AutoRefresh",
            "label": "üîÑ Auto Refresh",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[{\"value\": \"0\", \"label\": \"Off\"}, {\"value\": \"30000\", \"label\": \"30s\"}, {\"value\": \"60000\", \"label\": \"1m\"}, {\"value\": \"300000\", \"label\": \"5m\"}]",
            "value": "30000"
          },
          {
            "id": "funckey",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionKey",
            "label": "üîë Function Key (Auto-retrieved)",
            "type": 1,
            "description": "Auto-populated from Azure Function App keys - select Function App above",
            "isRequired": false,
            "isGlobal": true,
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"path\":\"{FunctionApp}/host/default/listKeys\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-03-01\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.functionKeys.default\",\"columnid\":\"key\"}]}}]}",
            "queryType": 12,
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "global-parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üìä Dashboard Overview\n\n**Real-time metrics and quick access to common operations**"
            },
            "name": "dashboard-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"DeviceID\"},{\"path\": \"$.riskScore\",\"columnid\": \"RiskScore\"},{\"path\": \"$.healthStatus\",\"columnid\": \"Health\"},{\"path\": \"$.exposureLevel\",\"columnid\": \"Exposure\"}]}}]}",
              "size": 4,
              "title": "üñ•Ô∏è Device Fleet Health",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Health",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "DeviceID",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "dashboard-device-health"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get All Actions\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.actions[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"ActionID\"},{\"path\": \"$.type\",\"columnid\": \"Type\"},{\"path\": \"$.status\",\"columnid\": \"Status\"}]}}]}",
              "size": 4,
              "title": "‚ö° Recent Actions",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Type",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "ActionID",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "dashboard-actions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"DeviceID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"ComputerName\"},{\"path\": \"$.osPlatform\",\"columnid\": \"OS\"},{\"path\": \"$.riskScore\",\"columnid\": \"Risk\"},{\"path\": \"$.healthStatus\",\"columnid\": \"Health\"},{\"path\": \"$.exposureLevel\",\"columnid\": \"Exposure\"}]}}]}",
              "size": 0,
              "title": "üñ•Ô∏è Device Inventory (Top 10 by Risk)",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Risk",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü† {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Health",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Active",
                          "representation": "success",
                          "text": "‚úÖ {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Risk",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Risk",
                  "sortOrder": 2
                }
              ]
            },
            "name": "dashboard-inventory"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "dashboard"
      },
      "name": "dashboard-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üñ•Ô∏è Device Management\n\n**Complete device control with ARM actions and auto-refresh monitoring**\n\n---"
            },
            "name": "devices-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "dev-selected",
                  "version": "KqlParameterItem/1.0",
                  "name": "DeviceList",
                  "label": "üñ•Ô∏è Select Devices",
                  "type": 2,
                  "isRequired": false,
                  "isGlobal": true,
                  "multiSelect": true,
                  "quote": "",
                  "delimiter": ",",
                  "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"value\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"label\"}]}}]}",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 10,
                  "description": "‚úÖ Auto-populated from Defender XDR",
                  "value": null
                },
                {
                  "id": "fh",
                  "version": "KqlParameterItem/1.0",
                  "name": "FileHash",
                  "label": "ü¶† File Hash (SHA256)",
                  "type": 1,
                  "isGlobal": true,
                  "description": "Enter SHA256 hash for file quarantine",
                  "value": ""
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "devices-parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã Device Selection & Actions\n\n**Selected:** `{DeviceList:nonempty:{DeviceList}|None}` | **File Hash:** `{FileHash:nonempty:{FileHash}|Not specified}`"
            },
            "name": "devices-step1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"DeviceID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"ComputerName\"},{\"path\": \"$.osPlatform\",\"columnid\": \"OS\"},{\"path\": \"$.healthStatus\",\"columnid\": \"Health\"},{\"path\": \"$.riskScore\",\"columnid\": \"Risk\"},{\"path\": \"$.exposureLevel\",\"columnid\": \"Exposure\"},{\"path\": \"$.ipAddresses[0]\",\"columnid\": \"IP\"}]}}]}",
              "size": 0,
              "title": "üñ•Ô∏è All Devices",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Health",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Active",
                          "representation": "success",
                          "text": "‚úÖ {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Risk",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü† {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Exposure",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü† {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "ComputerName",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "ComputerName",
                  "sortOrder": 1
                }
              ]
            },
            "name": "devices-inventory"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### ‚ö†Ô∏è STEP 2: Conflict Detection\n\n**Smart Filter:** Showing actions for selected devices only"
            },
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "devices-step2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get All Actions\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.actions[*]\",\"columns\": [{\"path\": \"$.machineId\",\"columnid\": \"DeviceID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"Device\"},{\"path\": \"$.type\",\"columnid\": \"Action\"},{\"path\": \"$.id\",\"columnid\": \"ActionID\"},{\"path\": \"$.status\",\"columnid\": \"Status\"}]}}]}",
              "size": 0,
              "title": "‚öôÔ∏è Pending Actions on Selected Devices",
              "noDataMessage": "‚úÖ NO CONFLICTS - Safe to execute",
              "noDataMessageStyle": 3,
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "Default",
                          "representation": "orange",
                          "text": "‚ö†Ô∏è {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "‚è≥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "2",
                          "text": "‚öôÔ∏è {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "filterSettings": {
                  "defaultFilters": [
                    {
                      "columnId": "DeviceID",
                      "operator": "in",
                      "value": "{DeviceList}"
                    },
                    {
                      "columnId": "Status",
                      "operator": "in",
                      "value": "Pending,InProgress"
                    }
                  ]
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "devices-conflicts"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### ‚ö° STEP 3: Execute ARM Actions\n\n**Selected Devices:** `{DeviceList}`  \n**Azure will show confirmation dialog before execution**"
            },
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "devices-step3"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-run-antivirus-scan",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîç Execute: Run Antivirus Scan",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Run Antivirus Scan",
                    "description": "Run Antivirus Scan initiated successfully",
                    "actionName": "Run Antivirus Scan",
                    "runLabel": "Execute Run Antivirus Scan",
                    "successMessage": "‚úÖ Run Antivirus Scan command sent successfully!",
                    "body": "{\"action\": \"Run Antivirus Scan\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Run Antivirus Scan via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-run-antivirus-scan-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-isolate-device",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîí Execute: Isolate Device (DESTRUCTIVE)",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Isolate Device",
                    "description": "Isolate Device initiated successfully",
                    "actionName": "Isolate Device",
                    "runLabel": "Execute Isolate Device",
                    "successMessage": "‚úÖ Isolate Device command sent successfully!",
                    "body": "{\"action\": \"Isolate Device\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Isolation via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-isolate-device-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-unisolate-device",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîì Execute: Unisolate Device",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Unisolate Device",
                    "description": "Unisolate Device initiated successfully",
                    "actionName": "Unisolate Device",
                    "runLabel": "Execute Unisolate Device",
                    "successMessage": "‚úÖ Unisolate Device command sent successfully!",
                    "body": "{\"action\": \"Unisolate Device\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Unisolation via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-unisolate-device-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-collect-investigation-package",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üì¶ Execute: Collect Investigation Package",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Collect Investigation Package",
                    "description": "Collect Investigation Package initiated successfully",
                    "actionName": "Collect Investigation Package",
                    "runLabel": "Execute Collect Investigation Package",
                    "successMessage": "‚úÖ Collect Investigation Package command sent successfully!",
                    "body": "{\"action\": \"Collect Investigation Package\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Investigation package via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-collect-investigation-package-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-restrict-app-execution",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Execute: Restrict App Execution (DESTRUCTIVE)",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Restrict App Execution",
                    "description": "Restrict App Execution initiated successfully",
                    "actionName": "Restrict App Execution",
                    "runLabel": "Execute Restrict App Execution",
                    "successMessage": "‚úÖ Restrict App Execution command sent successfully!",
                    "body": "{\"action\": \"Restrict App Execution\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Restrict App Execution via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-restrict-app-execution-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-unrestrict-app-execution",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚úÖ Execute: Unrestrict App Execution",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Unrestrict App Execution",
                    "description": "Unrestrict App Execution initiated successfully",
                    "actionName": "Unrestrict App Execution",
                    "runLabel": "Execute Unrestrict App Execution",
                    "successMessage": "‚úÖ Unrestrict App Execution command sent successfully!",
                    "body": "{\"action\": \"Unrestrict App Execution\", \"tenantId\": \"{TenantId}\", \"deviceIds\": \"{DeviceList}\", \"comment\": \"Unrestrict App Execution via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-unrestrict-app-execution-link",
            "conditionalVisibility": {
              "parameterName": "DeviceList",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-stop-&-quarantine-file",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "ü¶† Execute: Stop & Quarantine File",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2Dispatcher",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Stop & Quarantine File",
                    "description": "Stop & Quarantine File initiated successfully",
                    "actionName": "Stop & Quarantine File",
                    "runLabel": "Execute Stop & Quarantine File",
                    "successMessage": "‚úÖ Stop & Quarantine File command sent successfully!",
                    "body": "{\"action\": \"Stop & Quarantine File\", \"tenantId\": \"{TenantId}\", \"fileHash\": \"{FileHash}\", \"comment\": \"Quarantine via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-stop-&-quarantine-file-link",
            "conditionalVisibility": {
              "parameterName": "FileHash",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìä STEP 4: Action Monitoring\n\n**Live tracking with auto-refresh**"
            },
            "name": "devices-step4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get All Actions\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.actions[*]\",\"columns\": [{\"path\": \"$.machineId\",\"columnid\": \"DeviceID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"Device\"},{\"path\": \"$.type\",\"columnid\": \"Action\"},{\"path\": \"$.id\",\"columnid\": \"ActionID\"},{\"path\": \"$.status\",\"columnid\": \"Status\"},{\"path\": \"$.creationDateTimeUtc\",\"columnid\": \"Started\"},{\"path\": \"$.lastUpdateTimeUtc\",\"columnid\": \"Updated\"}]}}]}",
              "size": 0,
              "title": "‚öôÔ∏è Machine Actions History",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Isolate",
                          "representation": "orange",
                          "text": "üîí {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Scan",
                          "representation": "blue",
                          "text": "üîç {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "success",
                          "text": "‚úÖ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Failed",
                          "representation": "failed",
                          "text": "‚ùå {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "‚è≥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "2",
                          "text": "‚öôÔ∏è {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "filterSettings": {
                  "defaultFilters": [
                    {
                      "columnId": "DeviceID",
                      "operator": "in",
                      "value": "{DeviceList:nonempty:{DeviceList}|.*}"
                    }
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "Started",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Started",
                  "sortOrder": 2
                }
              ]
            },
            "name": "devices-history"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "devices"
      },
      "name": "devices-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üéÆ Live Response Console\n\n**Interactive shell for remote command execution on devices**\n\n---"
            },
            "name": "lr-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "lr-device",
                  "version": "KqlParameterItem/1.0",
                  "name": "LRDeviceId",
                  "label": "üñ•Ô∏è Target Device",
                  "type": 2,
                  "isRequired": false,
                  "isGlobal": true,
                  "multiSelect": false,
                  "quote": "",
                  "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"value\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"label\"}]}}]}",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 10,
                  "description": "‚úÖ Auto-populated from Defender XDR",
                  "value": null
                },
                {
                  "id": "lr-script",
                  "version": "KqlParameterItem/1.0",
                  "name": "LRScript",
                  "label": "üìú Script Name",
                  "type": 2,
                  "isRequired": false,
                  "isGlobal": true,
                  "multiSelect": false,
                  "quote": "",
                  "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Orchestrator?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"Function\",\"value\": \"ListLibraryFiles\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.files[*]\",\"columns\": [{\"path\": \"$.fileName\",\"columnid\": \"value\"},{\"path\": \"$.fileName\",\"columnid\": \"label\"}]}}]}",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 10,
                  "description": "‚úÖ Auto-populated from library",
                  "value": null
                },
                {
                  "id": "lr-filepath",
                  "version": "KqlParameterItem/1.0",
                  "name": "LRFilePath",
                  "label": "üìÅ File Path",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Full path to file on device (e.g., C:\\Windows\\System32\\notepad.exe)"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "lr-parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "### üéÆ Live Response Actions\n\n**Target Device:** `{LRDeviceId:nonempty:{LRDeviceId}|Not selected}` | **Script:** `{LRScript:nonempty:{LRScript}|None}` | **File Path:** `{LRFilePath:nonempty:{LRFilePath}|None}`"
            },
            "name": "lr-select-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"Get Devices\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.devices[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"DeviceID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"ComputerName\"},{\"path\": \"$.osPlatform\",\"columnid\": \"OS\"},{\"path\": \"$.healthStatus\",\"columnid\": \"Health\"}]}}]}",
              "size": 0,
              "title": "üñ•Ô∏è Available Devices (for reference)",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [],
                "filter": true
              }
            },
            "name": "lr-device-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìã Active Live Response Sessions"
            },
            "name": "lr-sessions-title"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Orchestrator?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"Function\",\"value\": \"GetLiveResponseSessions\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.sessions[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"SessionID\"},{\"path\": \"$.computerDnsName\",\"columnid\": \"Device\"},{\"path\": \"$.status\",\"columnid\": \"Status\"},{\"path\": \"$.createdBy\",\"columnid\": \"CreatedBy\"}]}}]}",
              "size": 0,
              "title": "üéÆ Live Response Sessions",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table"
            },
            "name": "lr-sessions-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üöÄ Execute Actions\n\n**Select action from dropdown above**"
            },
            "conditionalVisibility": {
              "parameterName": "LRDeviceId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "lr-actions-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-run-script",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîç Execute: Run Library Script",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2CDManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Run Script",
                    "description": "Run Script initiated successfully",
                    "actionName": "Run Script",
                    "runLabel": "Execute Run Script",
                    "successMessage": "‚úÖ Run Script command sent successfully!",
                    "body": "{\"action\": \"Run Script\", \"tenantId\": \"{TenantId}\", \"deviceId\": \"{LRDeviceId}\", \"scriptName\": \"{LRScript}\", \"comment\": \"Run script via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-run-script-link",
            "conditionalVisibility": {
              "parameterName": "LRDeviceId",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-get-file",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üì• Execute: Get File from Device",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2CDManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Get File",
                    "description": "Get File initiated successfully",
                    "actionName": "Get File",
                    "runLabel": "Execute Get File",
                    "successMessage": "‚úÖ Get File command sent successfully!",
                    "body": "{\"action\": \"Get File\", \"tenantId\": \"{TenantId}\", \"deviceId\": \"{LRDeviceId}\", \"filePath\": \"{LRFilePath}\", \"comment\": \"Get file via DefenderC2 Workbook\"}"
                  }
                }
              ]
            },
            "name": "arm-get-file-link",
            "conditionalVisibility": {
              "parameterName": "LRDeviceId",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìä Active Live Response Sessions"
            },
            "name": "lr-sessions-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Orchestrator?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"Function\",\"value\": \"GetLiveResponseSessions\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.sessions[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"SessionID\"},{\"path\": \"$.machineId\",\"columnid\": \"DeviceID\"},{\"path\": \"$.status\",\"columnid\": \"Status\"},{\"path\": \"$.createdBy\",\"columnid\": \"CreatedBy\"}]}}]}",
              "size": 0,
              "title": "üéÆ Live Response Sessions",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "filter": true
              }
            },
            "name": "lr-sessions-list"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "liveresponse"
      },
      "name": "liveresponse-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üìö File Library Manager\n\n**Upload, download, and manage files for Live Response operations**\n\n---"
            },
            "name": "library-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "lib-filename",
                  "version": "KqlParameterItem/1.0",
                  "name": "LibraryFileName",
                  "label": "üìÅ Select File from Library",
                  "type": 2,
                  "isRequired": false,
                  "isGlobal": true,
                  "multiSelect": false,
                  "quote": "",
                  "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Orchestrator?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"Function\",\"value\": \"ListLibraryFiles\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.data[*]\",\"columns\": [{\"path\": \"$.fileName\",\"columnid\": \"value\"},{\"path\": \"$.fileName\",\"columnid\": \"label\"}]}}]}",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 10,
                  "description": "‚úÖ Auto-populated from storage account",
                  "value": null
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "library-parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìö File Library (Azure Storage)\n\n**Selected File:** `{LibraryFileName:nonempty:{LibraryFileName}|None}`"
            },
            "name": "library-info-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Orchestrator?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"Function\",\"value\": \"ListLibraryFiles\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.data[*]\",\"columns\": [{\"path\": \"$.fileName\",\"columnid\": \"FileName\"},{\"path\": \"$.size\",\"columnid\": \"Size\"},{\"path\": \"$.lastModified\",\"columnid\": \"LastModified\"},{\"path\": \"$.contentType\",\"columnid\": \"ContentType\"}]}}]}",
              "size": 0,
              "title": "üìö All Library Files (for reference)",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Size",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "blue"
                    },
                    "numberFormat": {
                      "unit": 2,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "filter": true
              }
            },
            "name": "library-files-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üì§ File Operations\n\n**Selected File:** `{LibraryFileName:nonempty:{LibraryFileName}|None}`\n\n**Note:** Upload operation requires Base64-encoded file content. Download provides direct link."
            },
            "name": "library-operations-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-download-file",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üì• Execute: Download File from Library",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2CDManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Download File",
                    "description": "Download File initiated successfully",
                    "actionName": "Download File",
                    "runLabel": "Execute Download File",
                    "successMessage": "‚úÖ Download File command sent successfully!",
                    "body": "{\"action\": \"Download File\", \"tenantId\": \"{TenantId}\", \"fileName\": \"{LibraryFileName}\"}"
                  }
                }
              ]
            },
            "name": "arm-download-file-link",
            "conditionalVisibility": {
              "parameterName": "LibraryFileName",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-delete-file",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üóëÔ∏è Execute: Delete File from Library (DESTRUCTIVE)",
                  "style": "secondary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2CDManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Delete File",
                    "description": "Delete File initiated successfully",
                    "actionName": "Delete File",
                    "runLabel": "Execute Delete File",
                    "successMessage": "‚úÖ Delete File command sent successfully!",
                    "body": "{\"action\": \"Delete File\", \"tenantId\": \"{TenantId}\", \"fileName\": \"{LibraryFileName}\", \"comment\": \"Delete from library\"}"
                  }
                }
              ]
            },
            "name": "arm-delete-file-link",
            "conditionalVisibility": {
              "parameterName": "LibraryFileName",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "library"
      },
      "name": "library-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîç Advanced Hunting Console\n\n**Execute KQL queries across your Defender XDR environment**\n\n---"
            },
            "name": "hunting-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "hunt-query",
                  "version": "KqlParameterItem/1.0",
                  "name": "HuntQuery",
                  "label": "üìù KQL Query",
                  "type": 1,
                  "isGlobal": true,
                  "value": "DeviceInfo\\n| where Timestamp > ago(7d)\\n| summarize Count=count() by DeviceName, OSPlatform\\n| top 10 by Count",
                  "description": "Enter your KQL query here"
                },
                {
                  "id": "hunt-name",
                  "version": "KqlParameterItem/1.0",
                  "name": "HuntName",
                  "label": "üè∑Ô∏è Hunt Name",
                  "type": 1,
                  "isGlobal": true,
                  "value": "Device Summary - Last 7 Days",
                  "description": "Give your hunt a descriptive name"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "hunting-parameters"
          },
          {
            "type": 1,
            "content": {
              "json": "### üí° Quick Query Templates\n\n**Click to populate the query field:**\n\n**Device Queries:**\n- `DeviceInfo | where Timestamp > ago(7d) | summarize Count=count() by DeviceName, OSPlatform | top 10 by Count`\n- `DeviceProcessEvents | where Timestamp > ago(1d) | where ProcessCommandLine has 'powershell' | take 100`\n- `DeviceNetworkEvents | where Timestamp > ago(1d) | where RemoteIPType == 'Public' | take 100`\n\n**Security Queries:**\n- `AlertInfo | where Timestamp > ago(7d) | summarize Count=count() by Severity | order by Count desc`\n- `EmailEvents | where Timestamp > ago(7d) | where ThreatTypes has 'Phish' | take 100`\n- `IdentityLogonEvents | where Timestamp > ago(1d) | where ActionType == 'LogonFailed' | take 100`"
            },
            "name": "hunting-templates"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üöÄ Execute Hunt\n\n**Query:** `{HuntName}`"
            },
            "name": "hunting-execute-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-executehunt",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîç Execute: Advanced Hunting Query",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2HuntManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ ExecuteHunt",
                    "description": "ExecuteHunt initiated successfully",
                    "actionName": "ExecuteHunt",
                    "runLabel": "Execute ExecuteHunt",
                    "successMessage": "‚úÖ ExecuteHunt command sent successfully!",
                    "body": "{\"action\": \"ExecuteHunt\", \"tenantId\": \"{TenantId}\", \"huntQuery\": \"{HuntQuery}\", \"huntName\": \"{HuntName}\"}"
                  }
                }
              ]
            },
            "name": "arm-executehunt-link",
            "conditionalVisibility": {
              "parameterName": "HuntQuery",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìä Query Results\n\n**Results will be displayed in the ARM action response. For large result sets, consider using the DefenderC2 function app API directly.**\n\n**Available Tables in Defender XDR:**\n- `DeviceInfo`, `DeviceProcessEvents`, `DeviceNetworkEvents`, `DeviceFileEvents`\n- `AlertInfo`, `AlertEvidence`\n- `EmailEvents`, `EmailAttachmentInfo`, `EmailUrlInfo`\n- `IdentityLogonEvents`, `IdentityQueryEvents`, `IdentityDirectoryEvents`\n- `CloudAppEvents`"
            },
            "name": "hunting-results-info"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "hunting"
      },
      "name": "hunting-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ°Ô∏è Threat Intelligence Management\n\n**Manage indicators of compromise (IOCs) across your environment**\n\n---"
            },
            "name": "ti-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "ti-type",
                  "version": "KqlParameterItem/1.0",
                  "name": "TIType",
                  "label": "üéØ Indicator Type",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"file\", \"label\": \"üìÑ File Hash\"}, {\"value\": \"ip\", \"label\": \"üåê IP Address\"}, {\"value\": \"url\", \"label\": \"üîó URL/Domain\"}]",
                  "value": "file"
                },
                {
                  "id": "ti-value",
                  "version": "KqlParameterItem/1.0",
                  "name": "TIValue",
                  "label": "üîç Indicator Value",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Hash, IP, URL, or domain"
                },
                {
                  "id": "ti-title",
                  "version": "KqlParameterItem/1.0",
                  "name": "TITitle",
                  "label": "üè∑Ô∏è Title",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Indicator title/description"
                },
                {
                  "id": "ti-severity",
                  "version": "KqlParameterItem/1.0",
                  "name": "TISeverity",
                  "label": "‚ö†Ô∏è Severity",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"Informational\", \"label\": \"‚ÑπÔ∏è Informational\"}, {\"value\": \"Low\", \"label\": \"üü¢ Low\"}, {\"value\": \"Medium\", \"label\": \"üü° Medium\"}, {\"value\": \"High\", \"label\": \"üî¥ High\"}]",
                  "value": "High"
                },
                {
                  "id": "ti-action",
                  "version": "KqlParameterItem/1.0",
                  "name": "TIAction",
                  "label": "‚ö° Recommended Action",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"Alert\", \"label\": \"üîî Alert\"}, {\"value\": \"Block\", \"label\": \"üö´ Block\"}, {\"value\": \"Allow\", \"label\": \"‚úÖ Allow\"}]",
                  "value": "Block"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "ti-parameters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2TIManager?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"List All Indicators\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.indicators[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"IndicatorID\"},{\"path\": \"$.indicatorValue\",\"columnid\": \"Value\"},{\"path\": \"$.indicatorType\",\"columnid\": \"Type\"},{\"path\": \"$.title\",\"columnid\": \"Title\"},{\"path\": \"$.severity\",\"columnid\": \"Severity\"},{\"path\": \"$.action\",\"columnid\": \"Action\"}]}}]}",
              "size": 0,
              "title": "üõ°Ô∏è All Threat Indicators",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Severity",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü° {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "‚ÑπÔ∏è {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Action",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Block",
                          "representation": "redBright",
                          "text": "üö´ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Alert",
                          "representation": "orange",
                          "text": "üîî {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "green",
                          "text": "‚úÖ {0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "name": "ti-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### ‚ûï Add New Indicator\n\n**Type:** `{TIType}` | **Value:** `{TIValue:nonempty:{TIValue}|Not specified}` | **Severity:** `{TISeverity}` | **Action:** `{TIAction}`"
            },
            "name": "ti-add-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-add-file-indicator",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ûï Execute: Add File Indicator",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2TIManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Add File Indicator",
                    "description": "Add File Indicator initiated successfully",
                    "actionName": "Add File Indicator",
                    "runLabel": "Execute Add File Indicator",
                    "successMessage": "‚úÖ Add File Indicator command sent successfully!",
                    "body": "{\"action\": \"Add File Indicator\", \"tenantId\": \"{TenantId}\", \"indicatorValue\": \"{TIFileHash}\", \"title\": \"{TITitle}\", \"description\": \"{TIDescription}\", \"severity\": \"{TISeverity}\"}"
                  }
                }
              ]
            },
            "name": "arm-add-file-indicator-link",
            "conditionalVisibility": {
              "parameterName": "TIValue",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-add-ip-indicator",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ûï Execute: Add IP Indicator",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2TIManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Add IP Indicator",
                    "description": "Add IP Indicator initiated successfully",
                    "actionName": "Add IP Indicator",
                    "runLabel": "Execute Add IP Indicator",
                    "successMessage": "‚úÖ Add IP Indicator command sent successfully!",
                    "body": "{\"action\": \"Add IP Indicator\", \"tenantId\": \"{TenantId}\", \"indicatorValue\": \"{TIIPAddress}\", \"title\": \"{TITitle}\", \"description\": \"{TIDescription}\", \"severity\": \"{TISeverity}\"}"
                  }
                }
              ]
            },
            "name": "arm-add-ip-indicator-link",
            "conditionalVisibility": {
              "parameterName": "TIValue",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-add-url-indicator",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ûï Execute: Add URL/Domain Indicator",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2TIManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Add URL Indicator",
                    "description": "Add URL Indicator initiated successfully",
                    "actionName": "Add URL Indicator",
                    "runLabel": "Execute Add URL Indicator",
                    "successMessage": "‚úÖ Add URL Indicator command sent successfully!",
                    "body": "{\"action\": \"Add URL Indicator\", \"tenantId\": \"{TenantId}\", \"indicatorValue\": \"{TIURL}\", \"title\": \"{TITitle}\", \"description\": \"{TIDescription}\", \"severity\": \"{TISeverity}\"}"
                  }
                }
              ]
            },
            "name": "arm-add-url-indicator-link",
            "conditionalVisibility": {
              "parameterName": "TIValue",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "threatintel"
      },
      "name": "threatintel-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üö® Incident Management\n\n**View and manage security incidents from Defender XDR**\n\n---"
            },
            "name": "incidents-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "inc-severity",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentSeverity",
                  "label": "‚ö†Ô∏è Severity Filter",
                  "type": 2,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"\", \"label\": \"All Severities\"}, {\"value\": \"Informational\", \"label\": \"‚ÑπÔ∏è Informational\"}, {\"value\": \"Low\", \"label\": \"üü¢ Low\"}, {\"value\": \"Medium\", \"label\": \"üü° Medium\"}, {\"value\": \"High\", \"label\": \"üî¥ High\"}]",
                  "value": ""
                },
                {
                  "id": "inc-status",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentStatus",
                  "label": "üìä Status Filter",
                  "type": 2,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"\", \"label\": \"All Statuses\"}, {\"value\": \"Active\", \"label\": \"üî¥ Active\"}, {\"value\": \"Resolved\", \"label\": \"‚úÖ Resolved\"}, {\"value\": \"InProgress\", \"label\": \"‚öôÔ∏è In Progress\"}]",
                  "value": ""
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "incidents-parameters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2IncidentManager?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"GetIncidents\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"},{\"key\": \"severity\",\"value\": \"{IncidentSeverity}\"},{\"key\": \"status\",\"value\": \"{IncidentStatus}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.incidents[*]\",\"columns\": [{\"path\": \"$.incidentId\",\"columnid\": \"IncidentID\"},{\"path\": \"$.incidentName\",\"columnid\": \"Name\"},{\"path\": \"$.severity\",\"columnid\": \"Severity\"},{\"path\": \"$.status\",\"columnid\": \"Status\"},{\"path\": \"$.classification\",\"columnid\": \"Classification\"},{\"path\": \"$.createdTime\",\"columnid\": \"Created\"}]}}]}",
              "size": 0,
              "title": "üö® Security Incidents",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Severity",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü° {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "‚ÑπÔ∏è {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Active",
                          "representation": "failed",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Resolved",
                          "representation": "success",
                          "text": "‚úÖ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "2",
                          "text": "‚öôÔ∏è {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Created",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Created",
                  "sortOrder": 2
                }
              ]
            },
            "name": "incidents-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### ‚ö° Incident Actions\n\n**Manage Selected Incident**"
            },
            "name": "incidents-actions-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "inc-id",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentId",
                  "label": "üé´ Incident ID",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Enter incident ID to update"
                },
                {
                  "id": "inc-new-status",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentNewStatus",
                  "label": "üìä New Status",
                  "type": 2,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"Active\", \"label\": \"üî¥ Active\"}, {\"value\": \"Resolved\", \"label\": \"‚úÖ Resolved\"}, {\"value\": \"InProgress\", \"label\": \"‚öôÔ∏è In Progress\"}]",
                  "value": "Resolved"
                },
                {
                  "id": "inc-classification",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentClassification",
                  "label": "üè∑Ô∏è Classification",
                  "type": 2,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"TruePositive\", \"label\": \"‚úÖ True Positive\"}, {\"value\": \"FalsePositive\", \"label\": \"‚ùå False Positive\"}, {\"value\": \"BenignPositive\", \"label\": \"‚ÑπÔ∏è Benign Positive\"}, {\"value\": \"Unknown\", \"label\": \"‚ùì Unknown\"}]",
                  "value": "Unknown"
                },
                {
                  "id": "inc-comment",
                  "version": "KqlParameterItem/1.0",
                  "name": "IncidentComment",
                  "label": "üí¨ Comment",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Add comment to incident"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "incidents-action-parameters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2IncidentManager?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"UpdateIncident\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"},{\"key\": \"incidentId\",\"value\": \"{IncidentId}\"},{\"key\": \"status\",\"value\": \"{IncidentNewStatus}\"},{\"key\": \"classification\",\"value\": \"{IncidentClassification}\"},{\"key\": \"comment\",\"value\": \"{IncidentComment}\"}],\"transformers\": null}",
              "size": 4,
              "title": "üìù Update Incident Status",
              "noDataMessage": "Click to execute",
              "queryType": 10,
              "visualization": "table"
            },
            "conditionalVisibility": {
              "parameterName": "IncidentId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "incidents-update-action"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìä Incident Statistics\n\n**Filters Applied:** Severity: `{IncidentSeverity:nonempty:{IncidentSeverity}|All}` | Status: `{IncidentStatus:nonempty:{IncidentStatus}|All}`"
            },
            "name": "incidents-stats"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "incidents"
      },
      "name": "incidents-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üéØ Custom Detection Rules\n\n**Create and manage custom detection rules in Defender XDR**\n\n---"
            },
            "name": "detections-header"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "det-name",
                  "version": "KqlParameterItem/1.0",
                  "name": "DetectionName",
                  "label": "üè∑Ô∏è Detection Name",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "Name for new detection rule"
                },
                {
                  "id": "det-query",
                  "version": "KqlParameterItem/1.0",
                  "name": "DetectionQuery",
                  "label": "üìù Detection Query (KQL)",
                  "type": 1,
                  "isGlobal": true,
                  "value": "",
                  "description": "KQL query for detection logic"
                },
                {
                  "id": "det-severity",
                  "version": "KqlParameterItem/1.0",
                  "name": "DetectionSeverity",
                  "label": "‚ö†Ô∏è Severity",
                  "type": 2,
                  "isRequired": true,
                  "isGlobal": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\": \"Informational\", \"label\": \"‚ÑπÔ∏è Informational\"}, {\"value\": \"Low\", \"label\": \"üü¢ Low\"}, {\"value\": \"Medium\", \"label\": \"üü° Medium\"}, {\"value\": \"High\", \"label\": \"üî¥ High\"}]",
                  "value": "Medium"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "detections-parameters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\": \"CustomEndpoint/1.0\",\"data\": null,\"headers\": [],\"method\": \"POST\",\"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2CDManager?code={FunctionKey}\",\"body\": null,\"urlParams\": [{\"key\": \"action\",\"value\": \"List All Detections\"},{\"key\": \"tenantId\",\"value\": \"{TenantId}\"}],\"transformers\": [{\"type\": \"jsonpath\",\"settings\": {\"tablePath\": \"$.detections[*]\",\"columns\": [{\"path\": \"$.id\",\"columnid\": \"RuleID\"},{\"path\": \"$.displayName\",\"columnid\": \"Name\"},{\"path\": \"$.severity\",\"columnid\": \"Severity\"},{\"path\": \"$.enabled\",\"columnid\": \"Enabled\"},{\"path\": \"$.createdBy\",\"columnid\": \"CreatedBy\"}]}}]}",
              "size": 0,
              "title": "üéØ Custom Detection Rules",
              "showRefreshButton": true,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Severity",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "üî¥ {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "orange",
                          "text": "üü° {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "green",
                          "text": "üü¢ {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "‚ÑπÔ∏è {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Enabled",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "true",
                          "representation": "success",
                          "text": "‚úÖ Enabled"
                        },
                        {
                          "operator": "Default",
                          "representation": "disabled",
                          "text": "‚ùå Disabled"
                        }
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "name": "detections-list"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### ‚ûï Create New Detection Rule\n\n**Name:** `{DetectionName:nonempty:{DetectionName}|Not specified}` | **Severity:** `{DetectionSeverity}`"
            },
            "name": "detections-create-header"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "arm-create-detection",
                  "cellValue": "unused",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ûï Execute: Create Detection Rule",
                  "style": "primary",
                  "armActionContext": {
                    "path": "/subscriptions/{Subscription}/resourceGroups/{ResourceGroup}/providers/Microsoft.Web/sites/{FunctionAppName}/host/default/admin/functions/DefenderC2HuntManager",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2023-12-01"
                      }
                    ],
                    "httpMethod": "POST",
                    "title": "‚úÖ Create Detection",
                    "description": "Create Detection initiated successfully",
                    "actionName": "Create Detection",
                    "runLabel": "Execute Create Detection",
                    "successMessage": "‚úÖ Create Detection command sent successfully!",
                    "body": "{\"action\": \"Create Detection\", \"tenantId\": \"{TenantId}\", \"ruleName\": \"{DetectionName}\", \"query\": \"{DetectionQuery}\", \"severity\": \"{DetectionSeverity}\"}"
                  }
                }
              ]
            },
            "name": "arm-create-detection-link",
            "conditionalVisibility": {
              "parameterName": "DetectionName",
              "comparison": "isNotEqualTo",
              "value": ""
            }
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üí° Sample Detection Queries\n\n**Suspicious PowerShell:**\n```\nDeviceProcessEvents\n| where Timestamp > ago(1h)\n| where ProcessCommandLine has_any ('bypass', 'encodedcommand', 'invoke-expression')\n| where InitiatingProcessFileName !in ('explorer.exe', 'services.exe')\n```\n\n**Unusual Network Connections:**\n```\nDeviceNetworkEvents\n| where Timestamp > ago(1h)\n| where RemoteIPType == 'Public'\n| where RemotePort in (4444, 5555, 6666, 7777, 8888)\n```\n\n**Credential Access:**\n```\nDeviceProcessEvents\n| where Timestamp > ago(1h)\n| where ProcessCommandLine has_any ('mimikatz', 'sekurlsa', 'lsadump')\n```"
            },
            "name": "detections-samples"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "MainTab",
        "comparison": "isEqualTo",
        "value": "detections"
      },
      "name": "detections-group"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/YOUR-SUBSCRIPTION-ID/resourcegroups/YOUR-RESOURCE-GROUP"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}