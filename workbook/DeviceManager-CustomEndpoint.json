{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# \ud83d\udda5\ufe0f DefenderC2 Device Manager - CustomEndpoint\\n\\n## Device Selection Options:\\n1. **Click** device from inventory\\n2. **Type/Paste** device ID manually\\n\\n## Workflow:\\n\u2705 Select Device \u2192 \u2705 Choose Action \u2192 \u26a0\ufe0f Check Conflicts \u2192 \u2705 Type 'EXECUTE' \u2192 \u2705 Run"
      },
      "name": "header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "fa",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionApp",
            "label": "Function App",
            "type": 5,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where type == 'microsoft.web/sites' and kind == 'functionapp' | project id, name",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false,
              "resourceTypeFilter": {
                "microsoft.web/sites": true
              }
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "fn",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionAppName",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = name",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "tid",
            "version": "KqlParameterItem/1.0",
            "name": "TenantId",
            "label": "Defender Tenant",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "query": "ResourceContainers | where type == 'microsoft.resources/subscriptions' | project tenantId | distinct tenantId | project value = tenantId, label = strcat('Tenant: ', tenantId)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "selectFirstItem": true
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "dev",
            "version": "KqlParameterItem/1.0",
            "name": "DeviceList",
            "label": "\ud83d\udda5\ufe0f Device ID (click below OR type/paste)",
            "type": 1,
            "value": "",
            "isGlobal": true
          },
          {
            "id": "act",
            "version": "KqlParameterItem/1.0",
            "name": "ActionToExecute",
            "label": "\u26a1 Action",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "jsonData": "[{\"value\": \"none\", \"label\": \"-- Select --\"}, {\"value\": \"Run Antivirus Scan\", \"label\": \"\\ud83d\\udd0d Run Antivirus Scan\"}, {\"value\": \"Isolate Device\", \"label\": \"\\ud83d\\udd12 Isolate Device (DESTRUCTIVE)\"}, {\"value\": \"Unisolate Device\", \"label\": \"\\ud83d\\udd13 Unisolate Device\"}, {\"value\": \"Collect Investigation Package\", \"label\": \"\\ud83d\\udce6 Collect Package\"}, {\"value\": \"Restrict App Execution\", \"label\": \"\\ud83d\\udeab Restrict Apps (DESTRUCTIVE)\"}, {\"value\": \"Unrestrict App Execution\", \"label\": \"\\u2705 Unrestrict Apps\"}]",
            "value": "none"
          },
          {
            "id": "conf",
            "version": "KqlParameterItem/1.0",
            "name": "ConfirmExecution",
            "label": "\u26a0\ufe0f Type 'EXECUTE' to confirm",
            "type": 1,
            "value": "",
            "isGlobal": true
          },
          {
            "id": "aid",
            "version": "KqlParameterItem/1.0",
            "name": "ActionIdToCancel",
            "label": "\ud83d\uddd1\ufe0f Action ID (cancel)",
            "type": 1,
            "value": "",
            "isGlobal": true
          },
          {
            "id": "ref",
            "version": "KqlParameterItem/1.0",
            "name": "AutoRefresh",
            "label": "\ud83d\udd04 Refresh",
            "type": 2,
            "isGlobal": true,
            "jsonData": "[{\"value\": \"0\", \"label\": \"Off\"}, {\"value\": \"30000\", \"label\": \"30s\"}, {\"value\": \"60000\", \"label\": \"60s\"}]",
            "value": "30000"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "params"
    },
    {
      "type": 1,
      "content": {
        "json": "---\\n## \ud83d\udcbb Device Inventory\\n**Click 'Select' or copy Device ID**"
      },
      "name": "inv-hdr"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\": \"CustomEndpoint/1.0\", \"data\": null, \"headers\": [], \"method\": \"POST\", \"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\", \"body\": null, \"urlParams\": [{\"key\": \"action\", \"value\": \"Get Devices\"}, {\"key\": \"tenantId\", \"value\": \"{TenantId}\"}], \"transformers\": [{\"type\": \"jsonpath\", \"settings\": {\"tablePath\": \"$.devices[*]\", \"columns\": [{\"path\": \"$.id\", \"columnid\": \"Device ID\"}, {\"path\": \"$.computerDnsName\", \"columnid\": \"Name\"}, {\"path\": \"$.osPlatform\", \"columnid\": \"OS\"}, {\"path\": \"$.healthStatus\", \"columnid\": \"Health\"}]}}]}",
        "size": 0,
        "title": "\ud83d\udda5\ufe0f Devices",
        "queryType": 10,
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Device ID",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "parameter",
                "linkLabel": "\u2705 Select",
                "parameterName": "DeviceList",
                "parameterValue": "{0}"
              }
            },
            {
              "columnMatch": "Health",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Active",
                    "representation": "success",
                    "text": "\u2705 {0}"
                  }
                ]
              }
            }
          ],
          "filter": true
        }
      },
      "name": "inv-table"
    },
    {
      "type": 1,
      "content": {
        "json": "---\\n## \u26a0\ufe0f Conflict Check\\n**Device:** {DeviceList} | **Action:** {ActionToExecute}"
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionToExecute",
          "comparison": "isNotEqualTo",
          "value": "none"
        }
      ],
      "name": "conf-hdr"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\": \"CustomEndpoint/1.0\", \"data\": null, \"headers\": [], \"method\": \"POST\", \"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\", \"body\": null, \"urlParams\": [{\"key\": \"action\", \"value\": \"Get All Actions\"}, {\"key\": \"tenantId\", \"value\": \"{TenantId}\"}], \"transformers\": [{\"type\": \"jsonpath\", \"settings\": {\"tablePath\": \"$.actions[?(@.machineId == '{DeviceList}' && @.type == '{ActionToExecute}' && (@.status == 'Pending' || @.status == 'InProgress'))]\", \"columns\": [{\"path\": \"$.type\", \"columnid\": \"Action\"}, {\"path\": \"$.status\", \"columnid\": \"Status\"}, {\"path\": \"$.id\", \"columnid\": \"ID\"}]}}]}",
        "size": 0,
        "title": "\ud83d\udea8 CONFLICT DETECTED",
        "noDataMessage": "\u2705 No conflicts. Safe to execute.",
        "noDataMessageStyle": 3,
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "AutoRefresh",
        "queryType": 10,
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Action",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "Default",
                    "representation": "redBright",
                    "text": "\ud83d\udea8 {0}"
                  }
                ]
              }
            },
            {
              "columnMatch": "ID",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "parameter",
                "linkLabel": "\u274c Cancel",
                "parameterName": "ActionIdToCancel",
                "parameterValue": "{0}"
              }
            }
          ]
        }
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionToExecute",
          "comparison": "isNotEqualTo",
          "value": "none"
        }
      ],
      "name": "conf-table"
    },
    {
      "type": 1,
      "content": {
        "json": "---\\n## \u26a1 Execute\\n**Confirmation:** {ConfirmExecution}\\n\\n\u26a0\ufe0f **Type 'EXECUTE' above to enable**"
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionToExecute",
          "comparison": "isNotEqualTo",
          "value": "none"
        }
      ],
      "name": "exec-hdr"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\": \"CustomEndpoint/1.0\", \"data\": null, \"headers\": [], \"method\": \"POST\", \"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\", \"body\": null, \"urlParams\": [{\"key\": \"action\", \"value\": \"{ActionToExecute}\"}, {\"key\": \"tenantId\", \"value\": \"{TenantId}\"}, {\"key\": \"deviceIds\", \"value\": \"{DeviceList}\"}, {\"key\": \"comment\", \"value\": \"Workbook execution\"}], \"transformers\": [{\"type\": \"jsonpath\", \"settings\": {\"columns\": [{\"path\": \"$.message\", \"columnid\": \"Result\"}, {\"path\": \"$.actionIds[0]\", \"columnid\": \"Action ID\"}, {\"path\": \"$.status\", \"columnid\": \"Status\"}]}}]}",
        "size": 0,
        "title": "\u2705 Result",
        "queryType": 10,
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Action ID",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "parameter",
                "linkLabel": "\ud83d\udccb Track",
                "parameterName": "ActionIdToCancel",
                "parameterValue": "{0}"
              }
            },
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "Initiated",
                    "representation": "green",
                    "text": "\u2705 {0}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "error",
                    "representation": "redBright",
                    "text": "\u274c {0}"
                  }
                ]
              }
            }
          ]
        }
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionToExecute",
          "comparison": "isNotEqualTo",
          "value": "none"
        },
        {
          "parameterName": "ConfirmExecution",
          "comparison": "isEqualTo",
          "value": "EXECUTE"
        }
      ],
      "name": "exec-result"
    },
    {
      "type": 1,
      "content": {
        "json": "---\\n## \ud83d\udcca Action Status"
      },
      "name": "status-hdr"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\": \"CustomEndpoint/1.0\", \"data\": null, \"headers\": [], \"method\": \"POST\", \"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\", \"body\": null, \"urlParams\": [{\"key\": \"action\", \"value\": \"Get All Actions\"}, {\"key\": \"tenantId\", \"value\": \"{TenantId}\"}], \"transformers\": [{\"type\": \"jsonpath\", \"settings\": {\"tablePath\": \"$.actions[*]\", \"columns\": [{\"path\": \"$.machineId\", \"columnid\": \"Device ID\"}, {\"path\": \"$.computerDnsName\", \"columnid\": \"Device\"}, {\"path\": \"$.type\", \"columnid\": \"Action\"}, {\"path\": \"$.id\", \"columnid\": \"ID\"}, {\"path\": \"$.status\", \"columnid\": \"Status\"}]}}]}",
        "size": 0,
        "title": "\u2699\ufe0f All Actions",
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "AutoRefresh",
        "queryType": 10,
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ID",
              "formatter": 7,
              "formatOptions": {
                "linkTarget": "parameter",
                "linkLabel": "\u274c",
                "parameterName": "ActionIdToCancel",
                "parameterValue": "{0}"
              }
            },
            {
              "columnMatch": "Status",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "==",
                    "thresholdValue": "Pending",
                    "representation": "pending",
                    "text": "\u23f3 {0}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "InProgress",
                    "representation": "2",
                    "text": "\u2699\ufe0f {0}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Succeeded",
                    "representation": "success",
                    "text": "\u2705 {0}"
                  },
                  {
                    "operator": "==",
                    "thresholdValue": "Failed",
                    "representation": "failed",
                    "text": "\u274c {0}"
                  }
                ]
              }
            }
          ],
          "sortBy": [
            {
              "itemKey": "ID",
              "sortOrder": 2
            }
          ]
        }
      },
      "name": "status-table"
    },
    {
      "type": 1,
      "content": {
        "json": "---\\n## \u274c Cancel Action\\n**ID:** {ActionIdToCancel}"
      },
      "conditionalVisibility": {
        "parameterName": "ActionIdToCancel",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "cancel-hdr"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "{\"version\": \"CustomEndpoint/1.0\", \"data\": null, \"headers\": [], \"method\": \"POST\", \"url\": \"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\", \"body\": null, \"urlParams\": [{\"key\": \"action\", \"value\": \"Cancel Action\"}, {\"key\": \"tenantId\", \"value\": \"{TenantId}\"}, {\"key\": \"actionId\", \"value\": \"{ActionIdToCancel}\"}, {\"key\": \"comment\", \"value\": \"Cancelled\"}], \"transformers\": [{\"type\": \"jsonpath\", \"settings\": {\"columns\": [{\"path\": \"$.message\", \"columnid\": \"Result\"}, {\"path\": \"$.status\", \"columnid\": \"Status\"}]}}]}",
        "size": 0,
        "title": "\u2705 Cancellation",
        "queryType": 10,
        "visualization": "table"
      },
      "conditionalVisibility": {
        "parameterName": "ActionIdToCancel",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "cancel-result"
    }
  ],
  "styleSettings": {},
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}