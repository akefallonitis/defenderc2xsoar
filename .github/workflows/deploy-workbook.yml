name: Deploy Azure Workbook

on:
  push:
    branches:
      - main
    paths:
      - 'workbook/**'
  workflow_dispatch:

jobs:
  deploy-workbook:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v3

      - name: 'Login to Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Prepare Workbook Parameters'
        id: params
        run: |
          # Create a parameters file with the workbook content
          WORKBOOK_CONTENT=$(cat ./workbook/DefenderC2-Workbook.json | jq -c .)
          cat > /tmp/workbook-params.json <<EOF
          {
            "\$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
              "workbookSourceId": {
                "value": "${{ secrets.AZURE_WORKSPACE_RESOURCE_ID }}"
              },
              "location": {
                "value": "${{ secrets.AZURE_LOCATION }}"
              },
              "workbookContent": {
                "value": $WORKBOOK_CONTENT
              }
            }
          }
          EOF

      - name: 'Deploy Workbook Template'
        uses: azure/arm-deploy@v1
        with:
          scope: resourcegroup
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ secrets.AZURE_RESOURCE_GROUP }}
          template: ./deployment/workbook-deploy.json
          parameters: /tmp/workbook-params.json
