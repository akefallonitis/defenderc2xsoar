name: Deploy Azure Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'functions'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v3

      - name: 'Verify Function Structure'
        shell: pwsh
        run: |
          Write-Host "üîç Verifying function structure..." -ForegroundColor Cyan
          
          cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          
          # Verify all expected functions exist
          $expectedFunctions = @(
              'DefenderC2CDManager',
              'DefenderC2Dispatcher',
              'DefenderC2HuntManager',
              'DefenderC2IncidentManager',
              'DefenderC2TIManager',
              'DefenderC2Orchestrator',
              'ListLibraryFiles',
              'GetLibraryFile',
              'DeleteLibraryFile'
          )
          
          $missingFunctions = @()
          foreach ($func in $expectedFunctions) {
              if (-not (Test-Path $func)) {
                  $missingFunctions += $func
                  Write-Host "‚ùå Function not found: $func" -ForegroundColor Red
              }
              elseif (-not (Test-Path "$func/function.json")) {
                  $missingFunctions += "$func (missing function.json)"
                  Write-Host "‚ùå Missing function.json: $func" -ForegroundColor Red
              }
              elseif (-not (Test-Path "$func/run.ps1")) {
                  $missingFunctions += "$func (missing run.ps1)"
                  Write-Host "‚ùå Missing run.ps1: $func" -ForegroundColor Red
              }
              else {
                  Write-Host "‚úÖ Found function: $func" -ForegroundColor Green
              }
          }
          
          if ($missingFunctions.Count -gt 0) {
              Write-Host "`n‚ùå Deployment aborted - missing functions:" -ForegroundColor Red
              $missingFunctions | ForEach-Object { Write-Host "   - $_" -ForegroundColor Red }
              exit 1
          }
          
          # Verify required config files
          $requiredFiles = @('host.json', 'profile.ps1', 'requirements.psd1')
          foreach ($file in $requiredFiles) {
              if (Test-Path $file) {
                  Write-Host "‚úÖ Found config file: $file" -ForegroundColor Green
              }
              else {
                  Write-Host "‚ùå Missing config file: $file" -ForegroundColor Red
                  exit 1
              }
          }
          
          Write-Host "`n‚úÖ All $($expectedFunctions.Count) functions verified successfully!" -ForegroundColor Green

      - name: 'Create Deployment Package'
        shell: pwsh
        run: |
          Write-Host "üì¶ Creating deployment package..." -ForegroundColor Cyan
          
          cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          
          # Create ZIP package (Azure Functions action will handle this, but we verify it's ready)
          $functionCount = (Get-ChildItem -Directory | Where-Object { 
              (Test-Path "$_/function.json") -and (Test-Path "$_/run.ps1") 
          }).Count
          
          Write-Host "‚úÖ Package ready with $functionCount functions" -ForegroundColor Green

      - name: 'Deploy to Azure Functions'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

      - name: 'Verify Deployment'
        if: success()
        shell: pwsh
        run: |
          Write-Host "‚è≥ Waiting for deployment to complete..." -ForegroundColor Cyan
          Start-Sleep -Seconds 30
          
          Write-Host "‚úÖ Deployment completed successfully!" -ForegroundColor Green
          Write-Host "üìù Verify functions in Azure Portal:" -ForegroundColor Cyan
          Write-Host "   Navigate to Function App ‚Üí Functions" -ForegroundColor Gray
          Write-Host "   Expected: 9 functions deployed" -ForegroundColor Gray
