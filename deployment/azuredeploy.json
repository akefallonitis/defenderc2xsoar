{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "functionAppName": {
      "type": "string",
      "metadata": {
        "description": "The name of the function app to create. Must be globally unique."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "runtime": {
      "type": "string",
      "defaultValue": "powershell",
      "allowedValues": [
        "powershell"
      ],
      "metadata": {
        "description": "The language runtime of the function app."
      }
    },
    "spnId": {
      "type": "string",
      "metadata": {
        "description": "Multi-tenant App Registration (Service Principal) Client ID"
      }
    },
    "spnSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Multi-tenant App Registration (Service Principal) Client Secret"
      }
    },
    "enableManagedIdentity": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable system-assigned managed identity for the function app"
      }
    },
    "projectTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'Project' tag required by Azure Policy"
      }
    },
    "createdByTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'CreatedBy' tag required by Azure Policy"
      }
    },
    "deleteAtTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'DeleteAt' tag required by Azure Policy (e.g., '2025-12-31' or 'Never')"
      }
    },
    "repoUrl": {
      "type": "string",
      "defaultValue": "https://github.com/akefallonitis/defenderc2xsoar.git",
      "metadata": {
        "description": "The URL of the GitHub repository for source control configuration"
      }
    },
    "repoBranch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "The branch of the GitHub repository to use"
      }
    },
    "enableSourceControl": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable GitHub source control integration (requires GitHub token)"
      }
    }
  },
  "variables": {
    "functionAppName": "[parameters('functionAppName')]",
    "hostingPlanName": "[concat(parameters('functionAppName'), '-plan')]",
    "storageAccountName": "[concat('storage', uniqueString(resourceGroup().id))]",
    "functionWorkerRuntime": "[parameters('runtime')]",
    "packageUrl": "https://github.com/akefallonitis/defenderc2xsoar/raw/main/deployment/function-package.zip",
    "workbookContent": "ewogICJ2ZXJzaW9uIjogIk5vdGVib29rLzEuMCIsCiAgIml0ZW1zIjogWwogICAgewogICAgICAidHlwZSI6IDEsCiAgICAgICJjb250ZW50IjogewogICAgICAgICJqc29uIjogIiMgTURFQXV0b21hdG9yIFdvcmtib29rXG5cbj4gQSBwb3J0IG9mIFtNREVBdXRvbWF0b3JdKGh0dHBzOi8vZ2l0aHViLmNvbS9tc2RpcnRiYWcvTURFQXV0b21hdG9yKSB1c2luZyBBenVyZSBTZW50aW5lbCBXb3JrYm9va3MgZm9yIG11bHRpLXRlbmFudCBNaWNyb3NvZnQgRGVmZW5kZXIgZm9yIEVuZHBvaW50IGF1dG9tYXRpb24uXG5cbi0tLVxuXG4jIyBDb25maWd1cmF0aW9uXG5cbkNvbmZpZ3VyZSB5b3VyIHRlbmFudCBhbmQgZnVuY3Rpb24gYXBwIHNldHRpbmdzIGJlbG93OiIKICAgICAgfSwKICAgICAgIm5hbWUiOiAidGV4dCAtIGhlYWRlciIKICAgIH0sCiAgICB7CiAgICAgICJ0eXBlIjogOSwKICAgICAgImNvbnRlbnQiOiB7CiAgICAgICAgInZlcnNpb24iOiAiS3FsUGFyYW1ldGVySXRlbS8xLjAiLAogICAgICAgICJjcm9zc0NvbXBvbmVudFJlc291cmNlcyI6IFsKICAgICAgICAgICJ7U3Vic2NyaXB0aW9ufSIKICAgICAgICBdLAogICAgICAgICJwYXJhbWV0ZXJzIjogWwogICAgICAgICAgewogICAgICAgICAgICAiaWQiOiAiMWY3NGVkOWEtZTNlZC00OThkLWJkNWItZjY4ZjM4MzZhMTE3IiwKICAgICAgICAgICAgInZlcnNpb24iOiAiS3FsUGFyYW1ldGVySXRlbS8xLjAiLAogICAgICAgICAgICAibmFtZSI6ICJTdWJzY3JpcHRpb24iLAogICAgICAgICAgICAidHlwZSI6IDYsCiAgICAgICAgICAgICJpc1JlcXVpcmVkIjogdHJ1ZSwKICAgICAgICAgICAgIm11bHRpU2VsZWN0IjogdHJ1ZSwKICAgICAgICAgICAgInF1b3RlIjogIiciLAogICAgICAgICAgICAiZGVsaW1pdGVyIjogIiwiLAogICAgICAgICAgICAidHlwZVNldHRpbmdzIjogewogICAgICAgICAgICAgICJhZGRpdGlvbmFsUmVzb3VyY2VPcHRpb25zIjogWwogICAgICAgICAgICAgICAgInZhbHVlOjphbGwiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAiaW5jbHVkZUFsbCI6IGZhbHNlLAogICAgICAgICAgICAgICJzaG93RGVmYXVsdCI6IGZhbHNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ0aW1lQ29udGV4dCI6IHsKICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDg2NDAwMDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJkZWZhdWx0VmFsdWUiOiAidmFsdWU6OmFsbCIsCiAgICAgICAgICAgICJ2YWx1ZSI6IFsKICAgICAgICAgICAgICAidmFsdWU6OmFsbCIKICAgICAgICAgICAgXQogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogImI2MTZhM2EzLTQyNzEtNDIwOC1iMWE5LWE5MmE3OGVmZWQwOCIsCiAgICAgICAgICAgICJ2ZXJzaW9uIjogIktxbFBhcmFtZXRlckl0ZW0vMS4wIiwKICAgICAgICAgICAgIm5hbWUiOiAiV29ya3NwYWNlIiwKICAgICAgICAgICAgInR5cGUiOiA1LAogICAgICAgICAgICAiaXNSZXF1aXJlZCI6IHRydWUsCiAgICAgICAgICAgICJtdWx0aVNlbGVjdCI6IHRydWUsCiAgICAgICAgICAgICJxdW90ZSI6ICInIiwKICAgICAgICAgICAgImRlbGltaXRlciI6ICIsIiwKICAgICAgICAgICAgInF1ZXJ5IjogIlJlc291cmNlc1xufCB3aGVyZSB0eXBlID1+ICdtaWNyb3NvZnQub3BlcmF0aW9uYWxpbnNpZ2h0cy93b3Jrc3BhY2VzJ1xufCBwcm9qZWN0IGlkIiwKICAgICAgICAgICAgImNyb3NzQ29tcG9uZW50UmVzb3VyY2VzIjogWwogICAgICAgICAgICAgICJ7U3Vic2NyaXB0aW9ufSIKICAgICAgICAgICAgXSwKICAgICAgICAgICAgInR5cGVTZXR0aW5ncyI6IHsKICAgICAgICAgICAgICAiYWRkaXRpb25hbFJlc291cmNlT3B0aW9ucyI6IFsKICAgICAgICAgICAgICAgICJ2YWx1ZTo6YWxsIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgInNob3dEZWZhdWx0IjogZmFsc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInRpbWVDb250ZXh0IjogewogICAgICAgICAgICAgICJkdXJhdGlvbk1zIjogODY0MDAwMDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImRlZmF1bHRWYWx1ZSI6ICJ2YWx1ZTo6YWxsIiwKICAgICAgICAgICAgInF1ZXJ5VHlwZSI6IDEsCiAgICAgICAgICAgICJyZXNvdXJjZVR5cGUiOiAibWljcm9zb2Z0LnJlc291cmNlZ3JhcGgvcmVzb3VyY2VzIiwKICAgICAgICAgICAgInZhbHVlIjogWwogICAgICAgICAgICAgICJ2YWx1ZTo6YWxsIgogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICAiaWQiOiAiOGM0ZTVmMzgtYTZjZC00NjQyLTlmMGQtMmYyZTVkN2IzYzFhIiwKICAgICAgICAgICAgInZlcnNpb24iOiAiS3FsUGFyYW1ldGVySXRlbS8xLjAiLAogICAgICAgICAgICAibmFtZSI6ICJUZW5hbnRJZCIsCiAgICAgICAgICAgICJsYWJlbCI6ICJUYXJnZXQgVGVuYW50IElEIiwKICAgICAgICAgICAgInR5cGUiOiAxLAogICAgICAgICAgICAiaXNSZXF1aXJlZCI6IHRydWUsCiAgICAgICAgICAgICJ0aW1lQ29udGV4dCI6IHsKICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDg2NDAwMDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ2YWx1ZSI6ICIiCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICAiaWQiOiAiOWQ1ZTZmNDktYjdkZS01NzUzLWEwZTEtM2YzZjZlOGM0ZDJiIiwKICAgICAgICAgICAgInZlcnNpb24iOiAiS3FsUGFyYW1ldGVySXRlbS8xLjAiLAogICAgICAgICAgICAibmFtZSI6ICJGdW5jdGlvbkFwcFVybCIsCiAgICAgICAgICAgICJsYWJlbCI6ICJGdW5jdGlvbiBBcHAgQmFzZSBVUkwiLAogICAgICAgICAgICAidHlwZSI6IDEsCiAgICAgICAgICAgICJpc1JlcXVpcmVkIjogdHJ1ZSwKICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkJhc2UgVVJMIG9mIHlvdXIgQXp1cmUgRnVuY3Rpb24gQXBwIChlLmcuLCBodHRwczovL3lvdXItZnVuY3Rpb24tYXBwLmF6dXJld2Vic2l0ZXMubmV0KSIsCiAgICAgICAgICAgICJ0aW1lQ29udGV4dCI6IHsKICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDg2NDAwMDAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJ2YWx1ZSI6ICIiCiAgICAgICAgICB9LAogICAgICAgICAgewogICAgICAgICAgICAiaWQiOiAiYTFlN2Y1YS1jOGVmLTY4NjQtYjFmMi00ZzRnN2Y5ZDVlM2MiLAogICAgICAgICAgICAidmVyc2lvbiI6ICJLcWxQYXJhbWV0ZXJJdGVtLzEuMCIsCiAgICAgICAgICAgICJuYW1lIjogIlNwbklkIiwKICAgICAgICAgICAgImxhYmVsIjogIlNlcnZpY2UgUHJpbmNpcGFsIChBcHApIElEIiwKICAgICAgICAgICAgInR5cGUiOiAxLAogICAgICAgICAgICAiaXNSZXF1aXJlZCI6IHRydWUsCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJNdWx0aS10ZW5hbnQgQXBwIFJlZ2lzdHJhdGlvbiBDbGllbnQgSUQiLAogICAgICAgICAgICAidGltZUNvbnRleHQiOiB7CiAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiA4NjQwMDAwMAogICAgICAgICAgICB9LAogICAgICAgICAgICAidmFsdWUiOiAiIgogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogImIyZjhnNmItZDlmZy03OTc1LWMyZzMtNWg1aDhnMGU2ZjRkIiwKICAgICAgICAgICAgInZlcnNpb24iOiAiS3FsUGFyYW1ldGVySXRlbS8xLjAiLAogICAgICAgICAgICAibmFtZSI6ICJUaW1lUmFuZ2UiLAogICAgICAgICAgICAibGFiZWwiOiAiVGltZSBSYW5nZSIsCiAgICAgICAgICAgICJ0eXBlIjogNCwKICAgICAgICAgICAgImlzUmVxdWlyZWQiOiB0cnVlLAogICAgICAgICAgICAidHlwZVNldHRpbmdzIjogewogICAgICAgICAgICAgICJzZWxlY3RhYmxlVmFsdWVzIjogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDMwMDAwMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiA5MDAwMDAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJkdXJhdGlvbk1zIjogMTgwMDAwMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiAzNjAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDE0NDAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDQzMjAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDg2NDAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDE3MjgwMDAwMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiAyNTkyMDAwMDAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJkdXJhdGlvbk1zIjogNjA0ODAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDEyMDk2MDAwMDAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJkdXJhdGlvbk1zIjogMjQxOTIwMDAwMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiAyNTkyMDAwMDAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAiZHVyYXRpb25NcyI6IDUxODQwMDAwMDAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICJkdXJhdGlvbk1zIjogNzc3NjAwMDAwMAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgImFsbG93Q3VzdG9tIjogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICAidGltZUNvbnRleHQiOiB7CiAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiA4NjQwMDAwMAogICAgICAgICAgICB9LAogICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgImR1cmF0aW9uTXMiOiAyNTkyMDAwMDAwCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgICJzdHlsZSI6ICJwaWxscyIsCiAgICAgICAgInF1ZXJ5VHlwZSI6IDEsCiAgICAgICAgInJlc291cmNlVHlwZSI6ICJtaWNyb3NvZnQucmVzb3VyY2VncmFwaC9yZXNvdXJjZXMiCiAgICAgIH0sCiAgICAgICJuYW1lIjogInBhcmFtZXRlcnMgLSBjb25maWd1cmF0aW9uIgogICAgfSwKICAgIHsKICAgICAgInR5cGUiOiAxMSwKICAgICAgImNvbnRlbnQiOiB7CiAgICAgICAgInZlcnNpb24iOiAiTGlua0l0ZW0vMS4wIiwKICAgICAgICAic3R5bGUiOiAidGFicyIsCiAgICAgICAgImxpbmtzIjogWwogICAgICAgICAgewogICAgICAgICAgICAiaWQiOiAiNGU4YzNkN2EtMmIxZi00YThkLTllNWMtMWEyYjNjNGQ1ZTZmIiwKICAgICAgICAgICAgImNlbGxWYWx1ZSI6ICJzZWxlY3RlZFRhYiIsCiAgICAgICAgICAgICJsaW5rVGFyZ2V0IjogInBhcmFtZXRlciIsCiAgICAgICAgICAgICJsaW5rTGFiZWwiOiAiTURFQXV0b21hdG9yIiwKICAgICAgICAgICAgInN1YlRhcmdldCI6ICJhdXRvbWF0b3IiLAogICAgICAgICAgICAic3R5bGUiOiAibGluayIKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgICJpZCI6ICI1ZjlkNGU4Yi0zYzJnLTViOWUtMGY2ZC0yYjNjNGQ1ZTZmN2ciLAogICAgICAgICAgICAiY2VsbFZhbHVlIjogInNlbGVjdGVkVGFiIiwKICAgICAgICAgICAgImxpbmtUYXJnZXQiOiAicGFyYW1ldGVyIiwKICAgICAgICAgICAgImxpbmtMYWJlbCI6ICJUaHJlYXQgSW50ZWwgTWFuYWdlciIsCiAgICAgICAgICAgICJzdWJUYXJnZXQiOiAidGhyZWF0aW50ZWwiLAogICAgICAgICAgICAic3R5bGUiOiAibGluayIKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgICJpZCI6ICI2ZzBlNWY5Yy00ZDNoLTZjMGYtMWc3ZS0zYzRkNWU2ZjdnOGgiLAogICAgICAgICAgICAiY2VsbFZhbHVlIjogInNlbGVjdGVkVGFiIiwKICAgICAgICAgICAgImxpbmtUYXJnZXQiOiAicGFyYW1ldGVyIiwKICAgICAgICAgICAgImxpbmtMYWJlbCI6ICJBY3Rpb24gTWFuYWdlciIsCiAgICAgICAgICAgICJzdWJUYXJnZXQiOiAiYWN0aW9ucyIsCiAgICAgICAgICAgICJzdHlsZSI6ICJsaW5rIgogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogIjdoMWY2ZzBkLTVlNGktN2QxZy0yaDhmLTRkNWU2ZjdnOGg5aSIsCiAgICAgICAgICAgICJjZWxsVmFsdWUiOiAic2VsZWN0ZWRUYWIiLAogICAgICAgICAgICAibGlua1RhcmdldCI6ICJwYXJhbWV0ZXIiLAogICAgICAgICAgICAibGlua0xhYmVsIjogIkh1bnQgTWFuYWdlciIsCiAgICAgICAgICAgICJzdWJUYXJnZXQiOiAiaHVudGluZyIsCiAgICAgICAgICAgICJzdHlsZSI6ICJsaW5rIgogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogIjhpMmc3aDFlLTZmNWotOGUyaC0zaTlnLTVlNmY3ZzhoOWkwaiIsCiAgICAgICAgICAgICJjZWxsVmFsdWUiOiAic2VsZWN0ZWRUYWIiLAogICAgICAgICAgICAibGlua1RhcmdldCI6ICJwYXJhbWV0ZXIiLAogICAgICAgICAgICAibGlua0xhYmVsIjogIkluY2lkZW50IE1hbmFnZXIiLAogICAgICAgICAgICAic3ViVGFyZ2V0IjogImluY2lkZW50cyIsCiAgICAgICAgICAgICJzdHlsZSI6ICJsaW5rIgogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogIjlqM2g4aTJmLTdnNmstOWYzaS00ajBoLTZmN2c4aDlpMGoxayIsCiAgICAgICAgICAgICJjZWxsVmFsdWUiOiAic2VsZWN0ZWRUYWIiLAogICAgICAgICAgICAibGlua1RhcmdldCI6ICJwYXJhbWV0ZXIiLAogICAgICAgICAgICAibGlua0xhYmVsIjogIkN1c3RvbSBEZXRlY3Rpb24gTWFuYWdlciIsCiAgICAgICAgICAgICJzdWJUYXJnZXQiOiAiZGV0ZWN0aW9ucyIsCiAgICAgICAgICAgICJzdHlsZSI6ICJsaW5rIgogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgImlkIjogIjBrNGk5ajNnLThoN20tMWg1ay02bDJqLThoOWkwajFrMmwzbSIsCiAgICAgICAgICAgICJjZWxsVmFsdWUiOiAic2VsZWN0ZWRUYWIiLAogICAgICAgICAgICAibGlua1RhcmdldCI6ICJwYXJhbWV0ZXIiLAogICAgICAgICAgICAibGlua0xhYmVsIjogIlx1ZDgzZFx1ZGRhNVx1ZmUwZiBJbnRlcmFjdGl2ZSBDb25zb2xlIiwKICAgICAgICAgICAgInN1YlRhcmdldCI6ICJjb25zb2xlIiwKICAgICAgICAgICAgInN0eWxlIjogImxpbmsiCiAgICAgICAgICB9CiAgICAgICAgXQogICAgICB9LAogICAgICAibmFtZSI6ICJsaW5rcyAtIHRhYnMiCiAgICBICiAgXSwKICAiZGVmYXVsdFJlc291cmNlSWRzIjogWwogICAgIi9zdWJzY3JpcHRpb25zL1BMQUNFSE9MREVSIgogIF0sCiAgImZhbGxiYWNrUmVzb3VyY2VJZHMiOiBbCiAgICAiQXp1cmUgTW9uaXRvciIKICBdLAogICIkc2NoZW1hIjogImh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvQXBwbGljYXRpb24tSW5zaWdodHMtV29ya2Jvb2tzL2Jsb2IvbWFzdGVyL3NjaGVtYS93b3JrYm9vay5qc29uIgp9"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-03-01",
      "name": "[variables('hostingPlanName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "sku": {
        "name": "Y1",
        "tier": "Dynamic"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-03-01",
      "name": "[variables('functionAppName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "identity": {
        "type": "[if(parameters('enableManagedIdentity'), 'SystemAssigned', 'None')]"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower(variables('functionAppName'))]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "[variables('functionWorkerRuntime')]"
            },
            {
              "name": "APPID",
              "value": "[parameters('spnId')]"
            },
            {
              "name": "SECRETID",
              "value": "[parameters('spnSecret')]"
            },
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "[variables('packageUrl')]"
            },
            {
              "name": "PROJECT",
              "value": "functions"
            }
          ],
          "ftpsState": "FtpsOnly",
          "minTlsVersion": "1.2",
          "powerShellVersion": "7.4",
          "cors": {
            "allowedOrigins": [
              "https://portal.azure.com"
            ]
          }
        },
        "httpsOnly": true
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2021-03-08",
      "name": "[guid(resourceGroup().id, 'mde-automator-workbook')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "properties": {
        "displayName": "MDE Automator Workbook",
        "serializedData": "[base64ToString(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name)]",
        "category": "sentinel"
      }
    }
  ],
  "outputs": {
    "functionAppName": {
      "type": "string",
      "value": "[variables('functionAppName')]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(resourceId('Microsoft.Web/sites', variables('functionAppName'))).defaultHostName)]"
    },
    "functionAppResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[if(parameters('enableManagedIdentity'), reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').identity.principalId, '')]"
    },
    "publishProfileInstructions": {
      "type": "string",
      "value": "[concat('To get the publish profile for GitHub Actions, run: az functionapp deployment list-publishing-profiles --resource-group ', resourceGroup().name, ' --name ', variables('functionAppName'), ' --xml')]"
    },
    "githubSecretsSetup": {
      "type": "object",
      "value": {
        "AZURE_FUNCTIONAPP_NAME": "[variables('functionAppName')]",
        "AZURE_SUBSCRIPTION_ID": "[subscription().subscriptionId]",
        "AZURE_RESOURCE_GROUP": "[resourceGroup().name]",
        "AZURE_LOCATION": "[parameters('location')]",
        "instructions": "Configure these values as GitHub secrets. See AUTOMATED_DEPLOYMENT.md for detailed setup instructions."
      }
    }
  }
}
