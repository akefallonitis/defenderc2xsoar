{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "functionAppName": {
      "type": "string",
      "metadata": {
        "description": "The name of the function app to create. Must be globally unique."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "runtime": {
      "type": "string",
      "defaultValue": "powershell",
      "allowedValues": [
        "powershell"
      ],
      "metadata": {
        "description": "The language runtime of the function app."
      }
    },
    "spnId": {
      "type": "string",
      "metadata": {
        "description": "Multi-tenant App Registration (Service Principal) Client ID"
      }
    },
    "spnSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Multi-tenant App Registration (Service Principal) Client Secret"
      }
    },
    "enableManagedIdentity": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable system-assigned managed identity for the function app"
      }
    },
    "projectTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'Project' tag required by Azure Policy"
      }
    },
    "createdByTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'CreatedBy' tag required by Azure Policy"
      }
    },
    "deleteAtTag": {
      "type": "string",
      "metadata": {
        "description": "Value for the 'DeleteAt' tag required by Azure Policy (e.g., '2025-12-31' or 'Never')"
      }
    },
    "repoUrl": {
      "type": "string",
      "defaultValue": "https://github.com/akefallonitis/defenderc2xsoar.git",
      "metadata": {
        "description": "The URL of the GitHub repository for source control configuration"
      }
    },
    "repoBranch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "The branch of the GitHub repository to use"
      }
    },
    "enableSourceControl": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable GitHub source control integration (requires GitHub token)"
      }
    }
  },
  "variables": {
    "functionAppName": "[parameters('functionAppName')]",
    "hostingPlanName": "[concat(parameters('functionAppName'), '-plan')]",
    "storageAccountName": "[concat('storage', uniqueString(resourceGroup().id))]",
    "functionWorkerRuntime": "[parameters('runtime')]",
    "packageUrl": "https://github.com/akefallonitis/defenderc2xsoar/raw/main/deployment/function-package.zip",
    "workbookContent": "eyJ2ZXJzaW9uIjoiTm90ZWJvb2svMS4wIiwiaXRlbXMiOlt7InR5cGUiOjEsImNvbnRlbnQiOnsianNvbiI6IiMgTURFQXV0b21hdG9yIFdvcmtib29rXG5cbj4gQSBwb3J0IG9mIFtNREVBdXRvbWF0b3JdKGh0dHBzOi8vZ2l0aHViLmNvbS9tc2RpcnRiYWcvTURFQXV0b21hdG9yKSB1c2luZyBBenVyZSBTZW50aW5lbCBXb3JrYm9va3MgZm9yIG11bHRpLXRlbmFudCBNaWNyb3NvZnQgRGVmZW5kZXIgZm9yIEVuZHBvaW50IGF1dG9tYXRpb24uXG5cbi0tLVxuXG4jIyBDb25maWd1cmF0aW9uXG5cbkNvbmZpZ3VyZSB5b3VyIHRlbmFudCBhbmQgZnVuY3Rpb24gYXBwIHNldHRpbmdzIGJlbG93OiJ9LCJuYW1lIjoidGV4dCAtIGhlYWRlciJ9LHsidHlwZSI6OSwiY29udGVudCI6eyJ2ZXJzaW9uIjoiS3FsUGFyYW1ldGVySXRlbS8xLjAiLCJjcm9zc0NvbXBvbmVudFJlc291cmNlcyI6WyJ7U3Vic2NyaXB0aW9ufSJdLCJwYXJhbWV0ZXJzIjpbeyJpZCI6IjFmNzRlZDlhLWUzZWQtNDk4ZC1iZDViLWY2OGYzODM2YTExNyIsInZlcnNpb24iOiJLcWxQYXJhbWV0ZXJJdGVtLzEuMCIsIm5hbWUiOiJTdWJzY3JpcHRpb24iLCJ0eXBlIjo2LCJpc1JlcXVpcmVkIjp0cnVlLCJtdWx0aVNlbGVjdCI6dHJ1ZSwicXVvdGUiOiInIiwiZGVsaW1pdGVyIjoiLCIsInR5cGVTZXR0aW5ncyI6eyJhZGRpdGlvbmFsUmVzb3VyY2VPcHRpb25zIjpbInZhbHVlOjphbGwiXSwiaW5jbHVkZUFsbCI6ZmFsc2UsInNob3dEZWZhdWx0IjpmYWxzZX0sInRpbWVDb250ZXh0Ijp7ImR1cmF0aW9uTXMiOjg2NDAwMDAwfSwiZGVmYXVsdFZhbHVlIjoidmFsdWU6OmFsbCIsInZhbHVlIjpbInZhbHVlOjphbGwiXX0seyJpZCI6ImI2MTZhM2EzLTQyNzEtNDIwOC1iMWE5LWE5MmE3OGVmZWQwOCIsInZlcnNpb24iOiJLcWxQYXJhbWV0ZXJJdGVtLzEuMCIsIm5hbWUiOiJXb3Jrc3BhY2UiLCJ0eXBlIjo1LCJpc1JlcXVpcmVkIjp0cnVlLCJtdWx0aVNlbGVjdCI6dHJ1ZSwicXVvdGUiOiInIiwiZGVsaW1pdGVyIjoiLCIsInF1ZXJ5IjoiUmVzb3VyY2VzXG58IHdoZXJlIHR5cGUgPX4gJ21pY3Jvc29mdC5vcGVyYXRpb25hbGluc2lnaHRzL3dvcmtzcGFjZXMnXG58IHByb2plY3QgaWQiLCJjcm9zc0NvbXBvbmVudFJlc291cmNlcyI6WyJ7U3Vic2NyaXB0aW9ufSJdLCJ0eXBlU2V0dGluZ3MiOnsiYWRkaXRpb25hbFJlc291cmNlT3B0aW9ucyI6WyJ2YWx1ZTo6YWxsIl0sInNob3dEZWZhdWx0IjpmYWxzZX0sInRpbWVDb250ZXh0Ijp7ImR1cmF0aW9uTXMiOjg2NDAwMDAwfSwiZGVmYXVsdFZhbHVlIjoidmFsdWU6OmFsbCIsInF1ZXJ5VHlwZSI6MSwicmVzb3VyY2VUeXBlIjoibWljcm9zb2Z0LnJlc291cmNlZ3JhcGgvcmVzb3VyY2VzIiwidmFsdWUiOlsidmFsdWU6OmFsbCJdfSx7ImlkIjoiOGM0ZTVmMzgtYTZjZC00NjQyLTlmMGQtMmYyZTVkN2IzYzFhIiwidmVyc2lvbiI6IktxbFBhcmFtZXRlckl0ZW0vMS4wIiwibmFtZSI6IlRlbmFudElkIiwibGFiZWwiOiJUYXJnZXQgVGVuYW50IElEIiwidHlwZSI6MSwiaXNSZXF1aXJlZCI6dHJ1ZSwidGltZUNvbnRleHQiOnsiZHVyYXRpb25NcyI6ODY0MDAwMDB9LCJ2YWx1ZSI6IiJ9LHsiaWQiOiI5ZDVlNmY0OS1iN2RlLTU3NTMtYTBlMS0zZjNmNmU4YzRkMmIiLCJ2ZXJzaW9uIjoiS3FsUGFyYW1ldGVySXRlbS8xLjAiLCJuYW1lIjoiRnVuY3Rpb25BcHBVcmwiLCJsYWJlbCI6IkZ1bmN0aW9uIEFwcCBCYXNlIFVSTCIsInR5cGUiOjEsImlzUmVxdWlyZWQiOnRydWUsImRlc2NyaXB0aW9uIjoiQmFzZSBVUkwgb2YgeW91ciBBenVyZSBGdW5jdGlvbiBBcHAgKGUuZy4sIGh0dHBzOi8veW91ci1mdW5jdGlvbi1hcHAuYXp1cmV3ZWJzaXRlcy5uZXQpIiwidGltZUNvbnRleHQiOnsiZHVyYXRpb25NcyI6ODY0MDAwMDB9LCJ2YWx1ZSI6IiJ9LHsiaWQiOiJhMWU3ZjVhLWM4ZWYtNjg2NC1iMWYyLTRnNGc3ZjlkNWUzYyIsInZlcnNpb24iOiJLcWxQYXJhbWV0ZXJJdGVtLzEuMCIsIm5hbWUiOiJTcG5JZCIsImxhYmVsIjoiU2VydmljZSBQcmluY2lwYWwgKEFwcCkgSUQiLCJ0eXBlIjoxLCJpc1JlcXVpcmVkIjp0cnVlLCJkZXNjcmlwdGlvbiI6Ik11bHRpLXRlbmFudCBBcHAgUmVnaXN0cmF0aW9uIENsaWVudCBJRCIsInRpbWVDb250ZXh0Ijp7ImR1cmF0aW9uTXMiOjg2NDAwMDAwfSwidmFsdWUiOiIifSx7ImlkIjoiYjJmOGc2Yi1kOWZnLTc5NzUtYzJnMy01aDVoOGcwZTZmNGQiLCJ2ZXJzaW9uIjoiS3FsUGFyYW1ldGVySXRlbS8xLjAiLCJuYW1lIjoiVGltZVJhbmdlIiwibGFiZWwiOiJUaW1lIFJhbmdlIiwidHlwZSI6NCwiaXNSZXF1aXJlZCI6dHJ1ZSwidHlwZVNldHRpbmdzIjp7InNlbGVjdGFibGVWYWx1ZXMiOlt7ImR1cmF0aW9uTXMiOjMwMDAwMH0seyJkdXJhdGlvbk1zIjo5MDAwMDB9LHsiZHVyYXRpb25NcyI6MTgwMDAwMH0seyJkdXJhdGlvbk1zIjozNjAwMDAwfSx7ImR1cmF0aW9uTXMiOjE0NDAwMDAwfSx7ImR1cmF0aW9uTXMiOjQzMjAwMDAwfSx7ImR1cmF0aW9uTXMiOjg2NDAwMDAwfSx7ImR1cmF0aW9uTXMiOjE3MjgwMDAwMH0seyJkdXJhdGlvbk1zIjoyNTkyMDAwMDB9LHsiZHVyYXRpb25NcyI6NjA0ODAwMDAwfSx7ImR1cmF0aW9uTXMiOjEyMDk2MDAwMDB9LHsiZHVyYXRpb25NcyI6MjQxOTIwMDAwMH0seyJkdXJhdGlvbk1zIjoyNTkyMDAwMDAwfSx7ImR1cmF0aW9uTXMiOjUxODQwMDAwMDB9LHsiZHVyYXRpb25NcyI6Nzc3NjAwMDAwMH1dLCJhbGxvd0N1c3RvbSI6dHJ1ZX0sInRpbWVDb250ZXh0Ijp7ImR1cmF0aW9uTXMiOjg2NDAwMDAwfSwidmFsdWUiOnsiZHVyYXRpb25NcyI6MjU5MjAwMDAwMH19XSwic3R5bGUiOiJwaWxscyIsInF1ZXJ5VHlwZSI6MSwicmVzb3VyY2VUeXBlIjoibWljcm9zb2Z0LnJlc291cmNlZ3JhcGgvcmVzb3VyY2VzIn0sIm5hbWUiOiJwYXJhbWV0ZXJzIC0gY29uZmlndXJhdGlvbiJ9LHsidHlwZSI6MTEsImNvbnRlbnQiOnsidmVyc2lvbiI6IkxpbmtJdGVtLzEuMCIsInN0eWxlIjoidGFicyIsImxpbmtzIjpbeyJpZCI6IjRlOGMzZDdhLTJiMWYtNGE4ZC05ZTVjLTFhMmIzYzRkNWU2ZiIsImNlbGxWYWx1ZSI6InNlbGVjdGVkVGFiIiwibGlua1RhcmdldCI6InBhcmFtZXRlciIsImxpbmtMYWJlbCI6Ik1ERUF1dG9tYXRvciIsInN1YlRhcmdldCI6ImF1dG9tYXRvciIsInN0eWxlIjoibGluayJ9LHsiaWQiOiI1ZjlkNGU4Yi0zYzJnLTViOWUtMGY2ZC0yYjNjNGQ1ZTZmN2ciLCJjZWxsVmFsdWUiOiJzZWxlY3RlZFRhYiIsImxpbmtUYXJnZXQiOiJwYXJhbWV0ZXIiLCJsaW5rTGFiZWwiOiJUaHJlYXQgSW50ZWwgTWFuYWdlciIsInN1YlRhcmdldCI6InRocmVhdGludGVsIiwic3R5bGUiOiJsaW5rIn0seyJpZCI6IjZnMGU1ZjljLTRkM2gtNmMwZi0xZzdlLTNjNGQ1ZTZmN2c4aCIsImNlbGxWYWx1ZSI6InNlbGVjdGVkVGFiIiwibGlua1RhcmdldCI6InBhcmFtZXRlciIsImxpbmtMYWJlbCI6IkFjdGlvbiBNYW5hZ2VyIiwic3ViVGFyZ2V0IjoiYWN0aW9ucyIsInN0eWxlIjoibGluayJ9LHsiaWQiOiI3aDFmNmcwZC01ZTRpLTdkMWctMmg4Zi00ZDVlNmY3ZzhoOWkiLCJjZWxsVmFsdWUiOiJzZWxlY3RlZFRhYiIsImxpbmtUYXJnZXQiOiJwYXJhbWV0ZXIiLCJsaW5rTGFiZWwiOiJIdW50IE1hbmFnZXIiLCJzdWJUYXJnZXQiOiJodW50aW5nIiwic3R5bGUiOiJsaW5rIn0seyJpZCI6IjhpMmc3aDFlLTZmNWotOGUyaC0zaTlnLTVlNmY3ZzhoOWkwaiIsImNlbGxWYWx1ZSI6InNlbGVjdGVkVGFiIiwibGlua1RhcmdldCI6InBhcmFtZXRlciIsImxpbmtMYWJlbCI6IkluY2lkZW50IE1hbmFnZXIiLCJzdWJUYXJnZXQiOiJpbmNpZGVudHMiLCJzdHlsZSI6ImxpbmsifSx7ImlkIjoiOWozaDhpMmYtN2c2ay05ZjNpLTRqMGgtNmY3ZzhoOWkwajFrIiwiY2VsbFZhbHVlIjoic2VsZWN0ZWRUYWIiLCJsaW5rVGFyZ2V0IjoicGFyYW1ldGVyIiwibGlua0xhYmVsIjoiQ3VzdG9tIERldGVjdGlvbiBNYW5hZ2VyIiwic3ViVGFyZ2V0IjoiZGV0ZWN0aW9ucyIsInN0eWxlIjoibGluayJ9LHsiaWQiOiIwazRpOWozZy04aDdtLTFoNWstNmwyai04aDlpMGoxazJsM20iLCJjZWxsVmFsdWUiOiJzZWxlY3RlZFRhYiIsImxpbmtUYXJnZXQiOiJwYXJhbWV0ZXIiLCJsaW5rTGFiZWwiOiJcdWQ4M2RcdWRkYTVcdWZlMGYgSW50ZXJhY3RpdmUgQ29uc29sZSIsInN1YlRhcmdldCI6ImNvbnNvbGUiLCJzdHlsZSI6ImxpbmsifV19LCJuYW1lIjoibGlua3MgLSB0YWJzIn1dLCJkZWZhdWx0UmVzb3VyY2VJZHMiOlsiL3N1YnNjcmlwdGlvbnMvUExBQ0VIT0xERVIiXSwiZmFsbGJhY2tSZXNvdXJjZUlkcyI6WyJBenVyZSBNb25pdG9yIl0sIiRzY2hlbWEiOiJodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L0FwcGxpY2F0aW9uLUluc2lnaHRzLVdvcmtib29rcy9ibG9iL21hc3Rlci9zY2hlbWEvd29ya2Jvb2suanNvbiJ9"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-03-01",
      "name": "[variables('hostingPlanName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "sku": {
        "name": "Y1",
        "tier": "Dynamic"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-03-01",
      "name": "[variables('functionAppName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ],
      "identity": {
        "type": "[if(parameters('enableManagedIdentity'), 'SystemAssigned', 'None')]"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower(variables('functionAppName'))]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "[variables('functionWorkerRuntime')]"
            },
            {
              "name": "APPID",
              "value": "[parameters('spnId')]"
            },
            {
              "name": "SECRETID",
              "value": "[parameters('spnSecret')]"
            },
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "[variables('packageUrl')]"
            },
            {
              "name": "PROJECT",
              "value": "functions"
            }
          ],
          "ftpsState": "FtpsOnly",
          "minTlsVersion": "1.2",
          "powerShellVersion": "7.4",
          "cors": {
            "allowedOrigins": [
              "https://portal.azure.com"
            ]
          }
        },
        "httpsOnly": true
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2021-03-08",
      "name": "[guid(resourceGroup().id, 'mde-automator-workbook')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "tags": {
        "Project": "[parameters('projectTag')]",
        "CreatedBy": "[parameters('createdByTag')]",
        "DeleteAt": "[parameters('deleteAtTag')]"
      },
      "properties": {
        "displayName": "MDE Automator Workbook",
        "serializedData": "[base64ToString(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name)]",
        "category": "sentinel"
      }
    }
  ],
  "outputs": {
    "functionAppName": {
      "type": "string",
      "value": "[variables('functionAppName')]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(resourceId('Microsoft.Web/sites', variables('functionAppName'))).defaultHostName)]"
    },
    "functionAppResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[if(parameters('enableManagedIdentity'), reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-03-01', 'full').identity.principalId, '')]"
    },
    "publishProfileInstructions": {
      "type": "string",
      "value": "[concat('To get the publish profile for GitHub Actions, run: az functionapp deployment list-publishing-profiles --resource-group ', resourceGroup().name, ' --name ', variables('functionAppName'), ' --xml')]"
    },
    "githubSecretsSetup": {
      "type": "object",
      "value": {
        "AZURE_FUNCTIONAPP_NAME": "[variables('functionAppName')]",
        "AZURE_SUBSCRIPTION_ID": "[subscription().subscriptionId]",
        "AZURE_RESOURCE_GROUP": "[resourceGroup().name]",
        "AZURE_LOCATION": "[parameters('location')]",
        "instructions": "Configure these values as GitHub secrets. See AUTOMATED_DEPLOYMENT.md for detailed setup instructions."
      }
    }
  }
}