# DefenderXDR v2.3.0 - Deployment Guide

## üöÄ One-Click Deployment

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fakefallonitis%2Fdefenderc2xsoar%2Fmain%2Fdeployment%2Fazuredeploy.json)

##üì¶ What Gets Deployed

### Azure Resources
- **Azure Function App** (Consumption Plan, PowerShell 7.4)
- **Application Insights** (telemetry and monitoring)
- **Storage Account** (function app storage)
- **Azure Workbook** (DefenderC2 Command & Control Console)

### Function Apps (Auto-Deployed from Package)

**v2.3.0 Worker Architecture:**
1. **MDOWorker** - Microsoft Defender for Office 365 (email security)
2. **MDCWorker** - Microsoft Defender for Cloud (cloud security)
3. **MDIWorker** - Microsoft Defender for Identity (identity threats)
4. **EntraIDWorker** - Entra ID (identity & access management)
5. **IntuneWorker** - Intune (device management)
6. **AzureWorker** - Azure (infrastructure security)

**Legacy Functions (Backward Compatibility):**
- DefenderC2Dispatcher (MDE actions)
- DefenderXDRManager (XDR orchestration)
- DefenderC2CDManager, DefenderC2HuntManager, DefenderC2IncidentManager, DefenderC2TIManager, DefenderC2Orchestrator

### Shared Modules
- **AuthManager** - Centralized authentication with token caching
- **ValidationHelper** - Input validation and sanitization
- **LoggingHelper** - Structured logging with Application Insights
- **19 Service Modules** - MDE, MDO, MDC, MDI, Entra ID, Intune, Azure operations

---

## ‚öôÔ∏è Prerequisites

### 1. Multi-Tenant App Registration

You need an Entra ID App Registration with:

**Required API Permissions:**
```
Microsoft Graph:
- SecurityEvents.Read.All
- SecurityEvents.ReadWrite.All
- SecurityActions.Read.All
- SecurityActions.ReadWrite.All
- ThreatIndicators.ReadWrite.OwnedBy
- User.Read.All
- Directory.Read.All
- IdentityRiskEvent.Read.All
- IdentityRiskyUser.ReadWrite.All
- DeviceManagementManagedDevices.ReadWrite.All
- DeviceManagementConfiguration.ReadWrite.All

Windows Defender ATP (Microsoft Defender for Endpoint):
- Machine.Read.All
- Machine.ReadWrite.All
- Machine.Isolate
- Machine.RestrictExecution
- Machine.Offboard
- AdvancedQuery.Read.All
- Alert.Read.All
- Alert.ReadWrite.All
- Incident.Read.All
- Incident.ReadWrite.All
- Ti.ReadWrite.All
- Library.Manage

Azure Service Management:
- user_impersonation

Office 365 Exchange Online:
- Exchange.ManageAsApp
```

**Setup Steps:**
1. Go to Azure Portal ‚Üí Entra ID ‚Üí App registrations
2. Create new registration: "DefenderXDR Multi-Tenant Orchestrator"
3. **Authentication**: Don't configure (service principal only)
4. **API Permissions**: Add all permissions above ‚Üí Grant admin consent
5. **Certificates & Secrets**: Create client secret ‚Üí **Save it securely**
6. **Properties**: Set "Multi-tenant" if managing multiple tenants

**Save These Values:**
- Application (client) ID
- Client Secret
- Tenant ID (for each tenant you'll manage)

---

## üîß Deployment Steps

### Option 1: Azure Portal (Recommended)

1. **Click "Deploy to Azure" Button Above**

2. **Fill Required Parameters:**
   - **Function App Name**: Globally unique name (e.g., `defenderxdr-prod-001`)
   - **Location**: Azure region (e.g., `East US`)
   - **SPN ID**: Your App Registration Client ID
   - **SPN Secret**: Your App Registration Client Secret
   - **Project Tag**: Your project name (Azure Policy required)
   - **Created By Tag**: Your name/email (Azure Policy required)
   - **Delete At Tag**: Retention date or "Never" (Azure Policy required)

3. **Review + Create**
   - Deployment takes ~3-5 minutes
   - Functions are automatically deployed from GitHub package

4. **Verify Deployment:**
   ```powershell
   # Get function app URL
   az functionapp show --name <function-app-name> --resource-group <rg-name> --query defaultHostName -o tsv
   
   # List deployed functions
   az functionapp function list --name <function-app-name> --resource-group <rg-name> --query "[].name" -o table
   ```

### Option 2: Azure CLI

```bash
# Set variables
RG_NAME="rg-defenderxdr-prod"
LOCATION="eastus"
FUNCTION_APP_NAME="defenderxdr-prod-001"
SPN_ID="your-app-id-here"
SPN_SECRET="your-secret-here"

# Create resource group
az group create --name $RG_NAME --location $LOCATION

# Deploy ARM template
az deployment group create \
  --resource-group $RG_NAME \
  --template-file deployment/azuredeploy.json \
  --parameters \
    functionAppName=$FUNCTION_APP_NAME \
    spnId=$SPN_ID \
    spnSecret=$SPN_SECRET \
    projectTag="DefenderXDR" \
    createdByTag="your.name@company.com" \
    deleteAtTag="Never"
```

### Option 3: PowerShell

```powershell
# Set variables
$ResourceGroup = "rg-defenderxdr-prod"
$Location = "eastus"
$FunctionAppName = "defenderxdr-prod-001"
$SpnId = "your-app-id-here"
$SpnSecret = ConvertTo-SecureString "your-secret-here" -AsPlainText -Force

# Create resource group
New-AzResourceGroup -Name $ResourceGroup -Location $Location

# Deploy template
New-AzResourceGroupDeployment `
  -ResourceGroupName $ResourceGroup `
  -TemplateFile "deployment\azuredeploy.json" `
  -functionAppName $FunctionAppName `
  -spnId $SpnId `
  -spnSecret $SpnSecret `
  -projectTag "DefenderXDR" `
  -createdByTag "your.name@company.com" `
  -deleteAtTag "Never"
```

---

## üîç Post-Deployment Verification

### 1. Check Function App Status

```powershell
# Azure Portal
https://portal.azure.com ‚Üí Function Apps ‚Üí <your-function-app>

# Verify:
‚úì Function App is running
‚úì All 13 functions appear in Functions list
‚úì Application Insights is connected
```

### 2. Test Worker Endpoint

```powershell
$FunctionKey = "<get from portal>"
$FunctionUrl = "https://<your-app>.azurewebsites.net/api/EntraIDWorker"

$body = @{
    action = "GetUser"
    tenantId = "your-tenant-id"
    userId = "test.user@domain.com"
} | ConvertTo-Json

$response = Invoke-RestMethod `
    -Uri $FunctionUrl `
    -Method Post `
    -Headers @{"x-functions-key" = $FunctionKey} `
    -Body $body `
    -ContentType "application/json"

$response | ConvertTo-Json -Depth 5
```

**Expected Response:**
```json
{
  "success": true,
  "action": "GetUser",
  "tenantId": "xxx-xxx-xxx",
  "result": {
    "user": { /* user object */ }
  },
  "timestamp": "2025-11-10T12:34:56.789Z"
}
```

### 3. Check Application Insights

```kql
// Go to Application Insights ‚Üí Logs

// Recent requests
requests
| where timestamp > ago(1h)
| project timestamp, name, success, duration, resultCode
| order by timestamp desc

// Worker performance
requests
| where name endswith "Worker"
| summarize Count=count(), AvgDuration=avg(duration) by name
| order by Count desc
```

---

## üîÑ Auto-Update Mechanism

### How It Works

1. **WEBSITE_RUN_FROM_PACKAGE** app setting points to:
   ```
   https://github.com/akefallonitis/defenderc2xsoar/raw/main/deployment/function-package.zip
   ```

2. **When functions/ code changes:**
   - GitHub Actions workflow triggers
   - New package is created and validated
   - Package is committed to repo (auto-updates the GitHub raw URL)
   - Function App detects package change and auto-restarts

3. **Manual sync (if needed):**
   ```powershell
   # Restart function app to pull latest package
   az functionapp restart --name <function-app-name> --resource-group <rg-name>
   ```

### Package Update Process

```bash
# After making changes to functions/ directory:
git add functions/
git commit -m "Update worker functions"
git push

# GitHub Actions will:
# 1. Create new function-package.zip
# 2. Validate all workers exist
# 3. Auto-commit package back to repo
# 4. Your deployed function apps auto-update within ~5-10 minutes
```

---

## üîß Configuration

### Environment Variables (Auto-Set by ARM Template)

| Variable | Description | Source |
|----------|-------------|--------|
| `APPID` | Multi-tenant App Registration Client ID | ARM parameter |
| `SECRETID` | Multi-tenant App Registration Secret | ARM parameter (secure) |
| `WEBSITE_RUN_FROM_PACKAGE` | GitHub package URL | ARM template variable |
| `FUNCTIONS_EXTENSION_VERSION` | Azure Functions runtime | `~4` |
| `FUNCTIONS_WORKER_RUNTIME` | Runtime language | `powershell` |
| `APPINSIGHTS_INSTRUMENTATIONKEY` | Application Insights key | Auto-generated |

### Function-Level Authentication

All functions require **function-level keys**:

```powershell
# Get function key
az functionapp function keys list \
  --name <function-app-name> \
  --resource-group <rg-name> \
  --function-name MDOWorker \
  --query default -o tsv
```

Include in requests:
```http
POST https://<your-app>.azurewebsites.net/api/MDOWorker
x-functions-key: <function-key>
Content-Type: application/json

{
  "action": "RemediateEmail",
  "tenantId": "xxx",
  "messageId": "xxx"
}
```

---

## üìä Azure Workbook Integration

The deployment includes the **DefenderC2 Command & Control Console** workbook.

### Accessing the Workbook

1. Azure Portal ‚Üí Resource Group ‚Üí "DefenderC2 Command & Control Console"
2. Or: Azure Portal ‚Üí Monitor ‚Üí Workbooks ‚Üí "DefenderC2 Command & Control Console"

### Workbook Features

- **Device Management**: Isolate, scan, hunt on MDE devices
- **Email Security**: Remediate phishing emails, manage threats
- **Identity Protection**: Disable users, revoke sessions, reset passwords
- **Cloud Security**: View alerts, update recommendations, manage Defender plans
- **Custom Actions**: Call any worker endpoint with custom payloads

### Updating Workbook for v2.3.0 Workers

**Old Endpoint:**
```kql
let FunctionUrl = "https://your-app.azurewebsites.net/api/DefenderC2Dispatcher";
```

**New v2.3.0 Worker Endpoints:**
```kql
// Email security
let MDOWorkerUrl = "https://your-app.azurewebsites.net/api/MDOWorker";

// Cloud security
let MDCWorkerUrl = "https://your-app.azurewebsites.net/api/MDCWorker";

// Identity
let EntraIDWorkerUrl = "https://your-app.azurewebsites.net/api/EntraIDWorker";

// Device management
let IntuneWorkerUrl = "https://your-app.azurewebsites.net/api/IntuneWorker";
```

See **WORKER_ACTIONS_QUICKREF.md** for all available actions per worker.

---

## üîê Security Best Practices

### 1. Rotate Secrets Regularly

```powershell
# Update function app secret
az functionapp config appsettings set \
  --name <function-app-name> \
  --resource-group <rg-name> \
  --settings SECRETID="<new-secret>"
```

### 2. Use Managed Identity (Optional)

Enable system-assigned managed identity and grant it permissions:

```powershell
# Enable managed identity
az functionapp identity assign \
  --name <function-app-name> \
  --resource-group <rg-name>

# Grant permissions (example: Security Reader)
az role assignment create \
  --assignee <managed-identity-principal-id> \
  --role "Security Reader" \
  --scope "/subscriptions/<subscription-id>"
```

### 3. Restrict Network Access

```powershell
# Allow only specific IPs
az functionapp config access-restriction add \
  --name <function-app-name> \
  --resource-group <rg-name> \
  --rule-name "AllowCorporateIP" \
  --action Allow \
  --ip-address "203.0.113.0/24" \
  --priority 100
```

### 4. Enable Diagnostic Logs

```powershell
# Send logs to Log Analytics
az monitor diagnostic-settings create \
  --name "function-diagnostics" \
  --resource <function-app-resource-id> \
  --workspace <log-analytics-workspace-id> \
  --logs '[{"category": "FunctionAppLogs", "enabled": true}]'
```

---

## üêõ Troubleshooting

### Function App Not Starting

**Check:**
1. Application Insights ‚Üí Failures
2. Function App ‚Üí Diagnose and solve problems
3. WEBSITE_RUN_FROM_PACKAGE setting is correct

**Solution:**
```powershell
# Restart function app
az functionapp restart --name <name> --resource-group <rg>

# Check package URL is accessible
curl -I https://github.com/akefallonitis/defenderc2xsoar/raw/main/deployment/function-package.zip
```

### Authentication Errors

**Error:** `Failed to obtain authentication token`

**Solution:**
1. Verify APPID and SECRETID are correct
2. Check App Registration permissions are granted
3. Ensure admin consent was given
4. Verify tenant ID in request payload is correct

### Worker Not Found

**Error:** `404 Not Found` when calling worker

**Solution:**
```powershell
# List all functions
az functionapp function list --name <name> --resource-group <rg> --query "[].name"

# If worker missing, check package contents:
curl -L https://github.com/akefallonitis/defenderc2xsoar/raw/main/deployment/function-package.zip > package.zip
unzip -l package.zip | grep Worker
```

### Workbook Not Loading

**Check:**
1. Workbook deployed in correct resource group
2. Function app name is correct in workbook queries
3. Function keys are valid

---

## üìö Additional Resources

- **Architecture**: See `WORKER_PATTERN_ARCHITECTURE.md`
- **API Reference**: See `WORKER_ACTIONS_QUICKREF.md`
- **Implementation Details**: See `IMPLEMENTATION_COMPLETE.md`
- **Permissions**: See `PERMISSIONS.md`
- **Migration from v2.2.0**: See `MIGRATION_GUIDE.md`

---

## üÜò Support

For issues, enhancements, or questions:
- GitHub Issues: https://github.com/akefallonitis/defenderc2xsoar/issues
- Documentation: https://github.com/akefallonitis/defenderc2xsoar

---

## ‚úÖ Deployment Checklist

- [ ] Multi-tenant App Registration created with all permissions
- [ ] Admin consent granted for all API permissions
- [ ] Client Secret created and saved securely
- [ ] Deployed ARM template to Azure
- [ ] Verified all 13 functions deployed successfully
- [ ] Tested at least one worker endpoint
- [ ] Accessed Azure Workbook
- [ ] Configured Application Insights alerts (optional)
- [ ] Documented function keys for integration
- [ ] Set up automatic package updates (GitHub Actions)
- [ ] Reviewed security best practices
- [ ] Scheduled secret rotation reminders

**Deployment complete! üéâ**
