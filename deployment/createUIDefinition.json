{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "functionAppName",
        "type": "Microsoft.Common.TextBox",
        "label": "Function App Name",
        "defaultValue": "",
        "toolTip": "Enter a globally unique name for your function app. This will be used to create the Azure Function App resource.",
        "placeholder": "defenderxdr-func-prod",
        "constraints": {
          "required": true,
          "regex": "^[a-z0-9][a-z0-9-]{1,58}[a-z0-9]$",
          "validationMessage": "Function app name must be 3-60 characters, contain only lowercase letters, numbers, and hyphens, and cannot start or end with a hyphen."
        },
        "visible": true
      },
      {
        "name": "spnId",
        "type": "Microsoft.Common.TextBox",
        "label": "Multi-tenant App Registration (Client ID)",
        "defaultValue": "",
        "toolTip": "Enter the Application (client) ID from your multi-tenant app registration. This should be created before deploying this template.",
        "placeholder": "00000000-0000-0000-0000-000000000000",
        "constraints": {
          "required": true,
          "regex": "^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$",
          "validationMessage": "Please enter a valid GUID for the Application (client) ID."
        },
        "visible": true
      },
      {
        "name": "spnSecret",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "Client Secret",
          "confirmPassword": "Confirm Client Secret"
        },
        "toolTip": "Enter the client secret from your multi-tenant app registration. This will be stored securely in the function app settings.",
        "constraints": {
          "required": true
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "settings",
        "label": "Function App Settings",
        "elements": [
          {
            "name": "enableManagedIdentity",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Managed Identity",
            "defaultValue": "Yes",
            "toolTip": "Enable system-assigned managed identity for the function app. This is recommended for secure authentication without storing secrets.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "infoBox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "After deployment completes, you will need to: 1) Configure federated identity credentials for the managed identity, 2) Deploy the function code, and 3) Deploy the workbook template. See the documentation for detailed instructions."
            }
          }
        ]
      },
      {
        "name": "tags",
        "label": "Resource Tags",
        "elements": [
          {
            "name": "projectTag",
            "type": "Microsoft.Common.TextBox",
            "label": "Project Tag",
            "defaultValue": "",
            "toolTip": "Enter the project name. This tag is required by Azure Policy.",
            "placeholder": "DefenderC2XSOAR",
            "constraints": {
              "required": true
            },
            "visible": true
          },
          {
            "name": "createdByTag",
            "type": "Microsoft.Common.TextBox",
            "label": "CreatedBy Tag",
            "defaultValue": "",
            "toolTip": "Enter the name or email of the person/team creating this resource. This tag is required by Azure Policy.",
            "placeholder": "john.doe@example.com",
            "constraints": {
              "required": true
            },
            "visible": true
          },
          {
            "name": "deleteAtTag",
            "type": "Microsoft.Common.TextBox",
            "label": "DeleteAt Tag",
            "defaultValue": "Never",
            "toolTip": "Enter the date when this resource should be deleted (YYYY-MM-DD) or 'Never' if it should be kept indefinitely. This tag is required by Azure Policy.",
            "placeholder": "Never",
            "constraints": {
              "required": true
            },
            "visible": true
          },
          {
            "name": "tagInfoBox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "These tags are required by your Azure subscription policies. All resources created by this template will be tagged with these values."
            }
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "functionAppName": "[basics('functionAppName')]",
      "spnId": "[basics('spnId')]",
      "spnSecret": "[basics('spnSecret')]",
      "enableManagedIdentity": "[steps('settings').enableManagedIdentity]",
      "projectTag": "[steps('tags').projectTag]",
      "createdByTag": "[steps('tags').createdByTag]",
      "deleteAtTag": "[steps('tags').deleteAtTag]"
    }
  }
}
