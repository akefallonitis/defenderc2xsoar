{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "functionAppName",
        "type": "Microsoft.Common.TextBox",
        "label": "Function App Name",
        "defaultValue": "",
        "toolTip": "Enter a globally unique name for your function app. This will be used to create the Azure Function App resource.",
        "placeholder": "mde-automator-func-prod",
        "constraints": {
          "required": true,
          "regex": "^[a-z0-9][a-z0-9-]{1,58}[a-z0-9]$",
          "validationMessage": "Function app name must be 3-60 characters, contain only lowercase letters, numbers, and hyphens, and cannot start or end with a hyphen."
        },
        "visible": true
      },
      {
        "name": "spnId",
        "type": "Microsoft.Common.TextBox",
        "label": "Multi-tenant App Registration (Client ID)",
        "defaultValue": "",
        "toolTip": "Enter the Application (client) ID from your multi-tenant app registration. This should be created before deploying this template.",
        "placeholder": "00000000-0000-0000-0000-000000000000",
        "constraints": {
          "required": true,
          "regex": "^[{]?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}[}]?$",
          "validationMessage": "Please enter a valid GUID for the Application (client) ID."
        },
        "visible": true
      }
    ],
    "steps": [
      {
        "name": "settings",
        "label": "Function App Settings",
        "elements": [
          {
            "name": "enableManagedIdentity",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Managed Identity",
            "defaultValue": "Yes",
            "toolTip": "Enable system-assigned managed identity for the function app. This is recommended for secure authentication without storing secrets.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "infoBox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "After deployment completes, you will need to: 1) Configure federated identity credentials for the managed identity, 2) Deploy the function code, and 3) Deploy the workbook template. See the documentation for detailed instructions."
            }
          }
        ]
      },
      {
        "name": "tags",
        "label": "Resource Tags",
        "elements": [
          {
            "name": "tagProject",
            "type": "Microsoft.Common.TextBox",
            "label": "Project Tag",
            "defaultValue": "DefenderC2XSOAR",
            "toolTip": "Project tag for resource organization and cost tracking. Required by Azure Policy.",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z0-9_-]+$",
              "validationMessage": "Project tag must contain only alphanumeric characters, underscores, and hyphens."
            },
            "visible": true
          },
          {
            "name": "tagCreatedBy",
            "type": "Microsoft.Common.TextBox",
            "label": "CreatedBy Tag",
            "defaultValue": "",
            "placeholder": "e.g., john.doe@contoso.com",
            "toolTip": "CreatedBy tag to identify who created the resource. Required by Azure Policy. If left empty, will default to 'ARM-{functionAppName}'.",
            "constraints": {
              "required": false
            },
            "visible": true
          },
          {
            "name": "tagDeleteAt",
            "type": "Microsoft.Common.TextBox",
            "label": "DeleteAt Tag",
            "defaultValue": "",
            "placeholder": "e.g., 2024-12-31",
            "toolTip": "DeleteAt tag for resource lifecycle management (ISO 8601 date format). Required by Azure Policy. Leave empty if no deletion date is planned.",
            "constraints": {
              "required": false,
              "regex": "^$|^\\d{4}-\\d{2}-\\d{2}$",
              "validationMessage": "DeleteAt tag must be in ISO 8601 date format (YYYY-MM-DD) or empty."
            },
            "visible": true
          },
          {
            "name": "tagsInfoBox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "These tags are required by Azure Policy. The Project tag is mandatory. CreatedBy and DeleteAt tags can be provided or left with default values."
            }
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "functionAppName": "[basics('functionAppName')]",
      "spnId": "[basics('spnId')]",
      "enableManagedIdentity": "[steps('settings').enableManagedIdentity]",
      "tagProject": "[steps('tags').tagProject]",
      "tagCreatedBy": "[if(empty(steps('tags').tagCreatedBy), concat('ARM-', basics('functionAppName')), steps('tags').tagCreatedBy)]",
      "tagDeleteAt": "[steps('tags').tagDeleteAt]"
    }
  }
}
