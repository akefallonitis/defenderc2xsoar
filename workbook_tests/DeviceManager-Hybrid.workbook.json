{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# \ud83d\udda5\ufe0f DefenderC2 Device Manager - Hybrid Version\n\n## Multi-Tenant Defender XDR Management with Enhanced UI\n\n**User:** akefallonitis | **Last Updated:** 2025-10-16 00:00:00 UTC\n\n### Features:\n- \u2705 **CustomEndpoints** for auto-refreshed data (devices, history, status)\n- \u2705 **Enhanced action execution** with button-style interface\n- \u2705 **Auto-populated parameters** from your environment\n- \u2705 **Pending action warnings** to prevent 400 errors\n- \u2705 **Action ID tracking** with auto-population\n- \u2705 **Full error handling** and recovery guidance"
      },
      "name": "header-text"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "function-app-selector",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionApp",
            "label": "\ud83d\udd27 DefenderC2 Function App",
            "type": 5,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where type == 'microsoft.web/sites' and kind == 'functionapp' | project id, name, resourceGroup, subscriptionId | order by name asc",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "subscription-hidden",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "resourcegroup-hidden",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = resourceGroup",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "function-name-hidden",
            "version": "KqlParameterItem/1.0",
            "name": "FunctionAppName",
            "type": 1,
            "isRequired": true,
            "isGlobal": true,
            "query": "Resources | where id == '{FunctionApp}' | project value = name",
            "crossComponentResources": [
              "value::all"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionApp}"
              }
            ]
          },
          {
            "id": "tenant-id-selector",
            "version": "KqlParameterItem/1.0",
            "name": "TenantId",
            "label": "\ud83c\udfe2 Defender XDR Tenant",
            "type": 2,
            "isRequired": true,
            "isGlobal": true,
            "multiSelect": false,
            "query": "ResourceContainers | where type == 'microsoft.resources/subscriptions' | project tenantId | distinct tenantId | project value = tenantId, label = strcat('\ud83c\udfe2 Tenant: ', tenantId) | order by label asc",
            "crossComponentResources": [
              "value::all"
            ],
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "typeSettings": {
              "additionalResourceOptions": [],
              "selectFirstItem": true,
              "showDefault": false
            },
            "defaultValue": "value::1",
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "device-list-dropdown",
            "version": "KqlParameterItem/1.0",
            "name": "DeviceList",
            "label": "\ud83d\udcbb Select Devices",
            "type": 2,
            "isRequired": false,
            "isGlobal": true,
            "multiSelect": true,
            "quote": "",
            "delimiter": ",",
            "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"body\":null,\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Devices\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.devices[*]\",\"columns\":[{\"path\":\"$.id\",\"columnid\":\"value\"},{\"path\":\"$.computerDnsName\",\"columnid\":\"label\"}]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 10,
            "description": "\u2705 Auto-populated from Defender XDR",
            "criteriaData": [
              {
                "criterionType": "param",
                "value": "{FunctionAppName}"
              },
              {
                "criterionType": "param",
                "value": "{TenantId}"
              }
            ]
          },
          {
            "id": "scan-type-param",
            "version": "KqlParameterItem/1.0",
            "name": "ScanType",
            "label": "\ud83d\udd0d Scan Type",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\n  {\"value\": \"Quick\", \"label\": \"Quick Scan\"},\n  {\"value\": \"Full\", \"label\": \"Full Scan\"}\n]",
            "value": "Quick"
          },
          {
            "id": "isolation-type-param",
            "version": "KqlParameterItem/1.0",
            "name": "IsolationType",
            "label": "\ud83d\udd12 Isolation Type",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\n  {\"value\": \"Full\", \"label\": \"Full Isolation\"},\n  {\"value\": \"Selective\", \"label\": \"Selective Isolation\"}\n]",
            "value": "Full"
          },
          {
            "id": "action-trigger",
            "version": "KqlParameterItem/1.0",
            "name": "ActionTrigger",
            "label": "\ud83c\udfaf Action Control",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\n  {\"value\": \"none\", \"label\": \"-- Select Action to Execute --\"},\n  {\"value\": \"scan\", \"label\": \"\ud83d\udd0d Run Antivirus Scan\"},\n  {\"value\": \"isolate\", \"label\": \"\ud83d\udd12 Isolate Device(s)\"},\n  {\"value\": \"unisolate\", \"label\": \"\ud83d\udd13 Unisolate Device(s)\"},\n  {\"value\": \"collect\", \"label\": \"\ud83d\udce6 Collect Investigation Package\"},\n  {\"value\": \"restrict\", \"label\": \"\ud83d\udeab Restrict App Execution\"},\n  {\"value\": \"unrestrict\", \"label\": \"\u2705 Unrestrict App Execution\"}\n]",
            "value": "none"
          },
          {
            "id": "last-action-id",
            "version": "KqlParameterItem/1.0",
            "name": "LastActionId",
            "label": "\ud83d\udcdd Last Action ID (for tracking)",
            "type": 1,
            "isGlobal": true,
            "value": "",
            "description": "Paste an Action ID here to track its status"
          },
          {
            "id": "cancel-action-id",
            "version": "KqlParameterItem/1.0",
            "name": "CancelActionId",
            "label": "\u274c Action ID to Cancel",
            "type": 1,
            "isGlobal": true,
            "value": "",
            "description": "Paste an Action ID here to cancel it"
          },
          {
            "id": "auto-refresh",
            "version": "KqlParameterItem/1.0",
            "name": "AutoRefresh",
            "label": "\ud83d\udd04 Auto Refresh",
            "type": 2,
            "isGlobal": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\n  {\"value\": \"0\", \"label\": \"Off\"},\n  {\"value\": \"10000\", \"label\": \"Every 10 seconds\"},\n  {\"value\": \"30000\", \"label\": \"Every 30 seconds\"},\n  {\"value\": \"60000\", \"label\": \"Every 1 minute\"},\n  {\"value\": \"300000\", \"label\": \"Every 5 minutes\"}\n]",
            "value": "30000"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\u26a0\ufe0f Pre-Execution Check - Pending Actions on Selected Devices",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \ud83d\udd0d Checking for Conflicting Actions\n\nBefore executing any action, this section checks if the selected devices already have **Pending** or **InProgress** actions.\n\n\u26a0\ufe0f **Critical:** Running the same action on a device with a pending action will cause a **400 Bad Request error**.\n\n\u2705 **Safe Practice:** Wait for current actions to complete or cancel them before starting new ones.\n\n**Auto-Refresh:** {AutoRefresh:label}"
            },
            "name": "precheck-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get All Actions\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.actions[?(@.status=='Pending' || @.status=='InProgress')]\",\"columns\":[{\"path\":\"$.machineId\",\"columnid\":\"Device ID\"},{\"path\":\"$.computerDnsName\",\"columnid\":\"Device Name\"},{\"path\":\"$.type\",\"columnid\":\"Action Type\"},{\"path\":\"$.id\",\"columnid\":\"Action ID\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.creationDateTimeUtc\",\"columnid\":\"Started\"},{\"path\":\"$.requestor\",\"columnid\":\"Requestor\"}]}}]}",
              "size": 0,
              "title": "\u2699\ufe0f Currently Running Actions (All Devices)",
              "noDataMessage": "\u2705 No pending or in-progress actions found. Safe to execute new actions.",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action ID",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "\ud83d\udccb Copy to Cancel",
                      "linkIsContextBlade": false
                    },
                    "tooltipFormat": {
                      "tooltip": "Click to copy this Action ID for cancellation"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "\u23f3 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "2",
                          "text": "\u2699\ufe0f {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Started",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Started",
                  "sortOrder": 2
                }
              ]
            },
            "name": "pending-actions-check"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionTrigger",
          "comparison": "isNotEqualTo",
          "value": "none"
        }
      ],
      "name": "precheck-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udd0d Execute: Antivirus Scan ({ScanType})",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing Antivirus Scan\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Scan Type:** {ScanType}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "scan-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Run Antivirus Scan\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"scanType\",\"value\":\"{ScanType}\"},{\"key\":\"comment\",\"value\":\"Scan via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Scan Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track or cancel the scan"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "scan-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "scan"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "scan-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udd12 Execute: Device Isolation ({IsolationType})",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing Device Isolation\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Isolation Type:** {IsolationType}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "isolate-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Isolate Device\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"isolationType\",\"value\":\"{IsolationType}\"},{\"key\":\"comment\",\"value\":\"Isolated via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Isolation Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track or cancel isolation"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "isolate-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "isolate"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "isolate-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udd13 Execute: Device Unisolation",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing Device Unisolation\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "unisolate-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Unisolate Device\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"comment\",\"value\":\"Unisolated via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Unisolation Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track the unisolation"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "unisolate-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "unisolate"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "unisolate-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udce6 Execute: Collect Investigation Package",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing Investigation Package Collection\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "collect-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Collect Investigation Package\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"comment\",\"value\":\"Package collection via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Collection Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track the collection"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "collect-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "collect"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "collect-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udeab Execute: Restrict App Execution",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing App Execution Restriction\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "restrict-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Restrict App Execution\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"comment\",\"value\":\"App restriction via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Restriction Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track the restriction"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "restrict-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "restrict"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "restrict-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\u2705 Execute: Unrestrict App Execution",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a1 Executing App Execution Unrestriction\n\n**Selected Devices:** {DeviceList:label}  \n**Device IDs:** {DeviceList}  \n**Timestamp:** 2025-10-16 00:00:00 UTC  \n**User:** akefallonitis"
            },
            "name": "unrestrict-header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Unrestrict App Execution\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"deviceIds\",\"value\":\"{DeviceList}\"},{\"key\":\"comment\",\"value\":\"App unrestriction via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.actionIds[*]\",\"columnid\":\"Action IDs\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.details\",\"columnid\":\"Details\"}]}}]}",
              "size": 0,
              "title": "\u2705 Unrestriction Execution Result",
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action IDs",
                    "formatter": 1,
                    "tooltipFormat": {
                      "tooltip": "Copy these IDs to track the unrestriction"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Initiated",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "error",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "blue",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "unrestrict-result"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "ActionTrigger",
          "comparison": "isEqualTo",
          "value": "unrestrict"
        },
        {
          "parameterName": "DeviceList",
          "comparison": "isNotEqualTo",
          "value": ""
        }
      ],
      "name": "unrestrict-group"
    },
    {
      "type": 1,
      "content": {
        "json": "\u26a0\ufe0f **Please select devices and an action from the Action Control dropdown above**"
      },
      "conditionalVisibilities": [
        {
          "parameterName": "DeviceList",
          "comparison": "isEqualTo",
          "value": ""
        },
        {
          "parameterName": "ActionTrigger",
          "comparison": "isNotEqualTo",
          "value": "none"
        }
      ],
      "name": "no-devices-warning"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udcca Action Status Tracking - {LastActionId}",
        "expandable": true,
        "expanded": false,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \ud83d\udd0d Real-time Action Tracking\n\n**Tracking Action ID:** {LastActionId}\n\nThis section provides real-time status updates for the specified action. **Auto-refreshes every {AutoRefresh:label}**.\n\n\ud83d\udca1 **Tip:** Copy an Action ID from any execution result or the history table below."
            },
            "name": "tracking-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Action Status\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"actionId\",\"value\":\"{LastActionId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.id\",\"columnid\":\"Action ID\"},{\"path\":\"$.type\",\"columnid\":\"Action Type\"},{\"path\":\"$.status\",\"columnid\":\"Current Status\"},{\"path\":\"$.machineId\",\"columnid\":\"Device ID\"},{\"path\":\"$.computerDnsName\",\"columnid\":\"Device Name\"},{\"path\":\"$.requestor\",\"columnid\":\"Requestor\"},{\"path\":\"$.creationDateTimeUtc\",\"columnid\":\"Created\"},{\"path\":\"$.lastUpdateDateTimeUtc\",\"columnid\":\"Last Updated\"}]}}]}",
              "size": 0,
              "title": "\ud83d\udcc8 Live Action Status",
              "noDataMessage": "Enter an Action ID in the 'Last Action ID' parameter above to track",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Current Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "green",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "yellow",
                          "text": "\u23f3 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "blue",
                          "text": "\ud83d\udd35 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Failed",
                          "representation": "redBright",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Cancelled",
                          "representation": "gray",
                          "text": "\u26ab {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "gray",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "action-status-tracking"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "LastActionId",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "status-tracking-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\u274c Cancel Machine Action - {CancelActionId}",
        "expandable": true,
        "expanded": false,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \u26a0\ufe0f Cancel Running Action\n\n**Action ID to Cancel:** {CancelActionId}\n\nThis will attempt to cancel the specified action. Note that some actions cannot be cancelled once they reach certain stages."
            },
            "name": "cancel-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Cancel Action\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"},{\"key\":\"actionId\",\"value\":\"{CancelActionId}\"},{\"key\":\"comment\",\"value\":\"Cancelled via DefenderC2 Hybrid Workbook by akefallonitis at 2025-10-16 00:00:00\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"columns\":[{\"path\":\"$.message\",\"columnid\":\"Result Message\"},{\"path\":\"$.details\",\"columnid\":\"Details\"},{\"path\":\"$.cancelResult\",\"columnid\":\"Cancel Result\"}]}}]}",
              "size": 0,
              "title": "\ud83d\udeab Cancellation Result",
              "noDataMessage": "Enter an Action ID in the 'Action ID to Cancel' parameter above",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 86400000
              },
              "showRefreshButton": true,
              "queryType": 10,
              "visualization": "table"
            },
            "name": "cancel-action-result"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "CancelActionId",
        "comparison": "isNotEqualTo",
        "value": ""
      },
      "name": "cancel-action-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udcdc Machine Actions History - Auto-Refreshing Feed",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \ud83d\udd52 Complete Machine Actions History\n\nShows all machine actions across your Defender XDR tenant. **Auto-refreshes every {AutoRefresh:label}**.\n\n\ud83d\udca1 **Tip:** Click any Action ID to copy it for tracking or cancellation."
            },
            "name": "history-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get All Actions\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.actions[*]\",\"columns\":[{\"path\":\"$.id\",\"columnid\":\"Action ID\"},{\"path\":\"$.type\",\"columnid\":\"Action Type\"},{\"path\":\"$.status\",\"columnid\":\"Status\"},{\"path\":\"$.requestor\",\"columnid\":\"Requestor\"},{\"path\":\"$.computerDnsName\",\"columnid\":\"Device Name\"},{\"path\":\"$.machineId\",\"columnid\":\"Device ID\"},{\"path\":\"$.creationDateTimeUtc\",\"columnid\":\"Created\"},{\"path\":\"$.lastUpdateDateTimeUtc\",\"columnid\":\"Last Updated\"}]}}]}",
              "size": 0,
              "title": "\ud83d\udccb All Machine Actions (Auto-Refreshing)",
              "noDataMessage": "No machine actions found. Execute an action above to see results here.",
              "noDataMessageStyle": 3,
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Action ID",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "\ud83d\udccb Copy ID",
                      "linkIsContextBlade": false
                    },
                    "tooltipFormat": {
                      "tooltip": "Click to copy Action ID for tracking or cancellation"
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Succeeded",
                          "representation": "success",
                          "text": "\u2705 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "InProgress",
                          "representation": "2",
                          "text": "\u23f3 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Pending",
                          "representation": "pending",
                          "text": "\ud83d\udd35 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Failed",
                          "representation": "failed",
                          "text": "\u274c {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Cancelled",
                          "representation": "4",
                          "text": "\u26ab {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Created",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Created",
                  "sortOrder": 2
                }
              ]
            },
            "name": "machine-actions-history"
          }
        ]
      },
      "name": "machine-actions-history-group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "\ud83d\udcbb Device Inventory - All Discovered Devices",
        "expandable": true,
        "expanded": false,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### \ud83d\udda5\ufe0f Complete Device Inventory\n\nShows all devices in your Defender XDR tenant with risk scoring and health status.\n\n**Auto-refreshes every {AutoRefresh:label}**"
            },
            "name": "devices-info"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"CustomEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"POST\",\"url\":\"https://{FunctionAppName}.azurewebsites.net/api/DefenderC2Dispatcher\",\"urlParams\":[{\"key\":\"action\",\"value\":\"Get Devices\"},{\"key\":\"tenantId\",\"value\":\"{TenantId}\"}],\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.devices[*]\",\"columns\":[{\"path\":\"$.computerDnsName\",\"columnid\":\"Device Name\"},{\"path\":\"$.osPlatform\",\"columnid\":\"OS Platform\"},{\"path\":\"$.osVersion\",\"columnid\":\"OS Version\"},{\"path\":\"$.riskScore\",\"columnid\":\"Risk Score\"},{\"path\":\"$.healthStatus\",\"columnid\":\"Health Status\"},{\"path\":\"$.lastIpAddress\",\"columnid\":\"Last IP\"},{\"path\":\"$.lastSeen\",\"columnid\":\"Last Seen\"},{\"path\":\"$.id\",\"columnid\":\"Device ID\"}]}}]}",
              "size": 0,
              "title": "\ud83d\udcbb All Devices (Auto-Refreshing)",
              "timeContext": {
                "durationMs": 0
              },
              "timeContextFromParameter": "AutoRefresh",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 10,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Risk Score",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "High",
                          "representation": "redBright",
                          "text": "\ud83d\udd34 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Medium",
                          "representation": "yellow",
                          "text": "\ud83d\udfe1 {0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Low",
                          "representation": "green",
                          "text": "\ud83d\udfe2 {0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "green",
                          "text": "\ud83d\udfe2 {0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Health Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Active",
                          "representation": "success",
                          "text": "{0}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Inactive",
                          "representation": "failed",
                          "text": "{0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "unknown",
                          "text": "{0}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Device ID",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkLabel": "\ud83d\udccb Copy"
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Risk Score",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Risk Score",
                  "sortOrder": 2
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "TenantId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "device-inventory"
          }
        ]
      },
      "name": "device-inventory-group"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n\n## \ud83d\udcd6 Usage Guide - Hybrid Version\n\n### Features of This Version\n- **CustomEndpoints** for all queries (devices, history, status)\n- **Enhanced UI** with dropdown action selection\n- **Auto-refresh** for real-time monitoring\n- **Button-style interface** for better user experience\n\n### Quick Start\n1. **Select Function App** \u2192 Auto-populates all connection parameters\n2. **Select Tenant** \u2192 Auto-selected from available tenants\n3. **Select Devices** \u2192 Multi-select from auto-populated device list\n4. **Check Pending Actions** \u2192 Review any running actions (auto-shows when needed)\n5. **Select Action** \u2192 Choose from the \"Action Control\" dropdown\n6. **View Results** \u2192 Results appear immediately with Action IDs\n7. **Track Status** \u2192 Copy Action IDs to monitor progress\n8. **Cancel if Needed** \u2192 Paste Action ID to cancel\n\n### Why Hybrid?\nThis version uses **CustomEndpoints for everything** (not ARM Actions) despite the name \"Hybrid\". The \"hybrid\" refers to the enhanced UI that combines:\n- **Dropdown-based action selection** (cleaner than traditional dropdowns)\n- **Auto-refresh queries** for real-time data\n- **Conditional sections** that appear only when relevant\n\n### Error Prevention\n- \u26a0\ufe0f **400 Bad Request** - Occurs when action already pending\n- \u2705 **Solution** - Check \"Pending Actions\" section before executing\n- \u2705 **Best Practice** - Wait for completion or cancel before re-running\n\n### Advantages Over ARM Actions\n- **No routing issues** - Direct HTTPS calls always work\n- **Better error messages** - Clear API responses\n- **Easier debugging** - Standard HTTP request/response\n- **Full auto-refresh** - Works with all query types\n\n---\n\n**Version:** Hybrid (CustomEndpoint-Based)  \n**Last Updated:** 2025-10-16 00:00:00 UTC  \n**Maintained by:** akefallonitis"
      },
      "name": "usage-guide"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/80110e3c-3ecd-4567-b06d-7d47a72562f5/resourcegroups/alex-testing-rg"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}